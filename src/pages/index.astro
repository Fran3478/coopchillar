---
export const prerender = false;

import Servicios from "../components/Servicios.astro";
import Layout from "../layouts/Layout.astro";
import Novedades from "../components/Novedades.astro";
import GalleryCollage from "../components/GalleryCollage.astro";
import GalleryMasonry from "../components/GalleryMasonry.astro";

import { fetchPublicPostsSSR, fetchPublicGallerySSR } from "../lib/cms.ts";
import NoticiaContenedor from "../components/NoticiaContenedor.astro";
import Carousel from "../components/Carousel.astro";

const base = new URL(Astro.request.url);
const TENANT_ID = Number(import.meta.env.PUBLIC_TENANT_ID || 1);

const novedades = await fetchPublicPostsSSR(base, TENANT_ID, {
	destacado: true,
	pageSize: 6,
});
const noticias = await fetchPublicPostsSSR(base, TENANT_ID, {
	tipo: "noticia",
	pageSize: 10,
});

const byDateDesc = (a, b) =>
	new Date(b.date || 0).getTime() - new Date(a.date || 0).getTime();
novedades.sort(byDateDesc);
noticias.sort(byDateDesc);

const galleryRaw = await fetchPublicGallerySSR(base, TENANT_ID, {
	pageSize: 24,
});

const galleryImages = galleryRaw.map((x) => ({
	src: x.src,
	alt: x.alt ?? "",
	description: x.description ?? "",
	album: x.album ?? "",
}));
---

<Layout
	title="Cooperativa Ltda. de Agua Potable y Otros Servicios Públicos de Chillar"
>
	<div id="main-content">
		<section id="home-hero">
			<Carousel />
			<aside class="hero-card custom-bg-card">
				<div class="card-shape"></div>
				<div class="card-logo">
					<img src="/images/logo.webp" alt="Logo" />
				</div>
				<div class="card-inner">
					<h3>OFICINA VIRTUAL</h3>
					<p>
						Realiza consultas de tus estados de cuenta y facturas.
						Haz tus pagos seguros en línea.
					</p>
					<a
						href="https://migestarcoop.com.ar/Chillar/login"
						class="cta-button">INGRESAR</a
					>
				</div>
			</aside>
		</section>
		<Servicios />
		<NoticiaContenedor {novedades} {noticias} />
		<!-- <Novedades {novedades} {noticias} /> -->
		<GalleryCollage images={galleryImages} />
		<!-- <GalleryMasonry images={galleryImages} /> -->
	</div>
</Layout>

<style>
	body {
		margin: 0;
	}
	html,
	body {
		min-height: 100%;
	}

	#main-content {
		margin: 0 3rem;
		padding-top: 120px;
	}

	@media (max-width: 700px) {
		#main-content {
			margin: 0 1rem;
		}
	}

	@media (max-width: 920px) {
		#main-content {
			padding-top: 104px;
		}
	}

	#home-hero {
		display: flex;
		align-items: stretch;
		gap: 2rem;
		max-width: 1200px;
		margin: auto;
		padding: 2rem 1rem;
	}

	.hero-card.custom-bg-card {
		flex: 0 0 300px;
		display: flex;
		justify-content: center;
		align-items: flex-end;
		padding-bottom: 2rem;
		position: relative;
		overflow: hidden;
		border-radius: 35px;
		background-image: url("/images/card_home.jpg");
		background-size: cover;
		background-position: center;
	}
	.hero-card.custom-bg-card::before {
		content: "";
		position: absolute;
		inset: 0;
		background: rgba(0, 33, 66, 0.3);
		z-index: 0;
	}
	.card-shape {
		position: absolute;
		width: calc(100% - 2rem);
		max-width: 280px;
		height: 14rem;
		bottom: 1rem;
		left: 1rem;
		background: white;
		border-radius: 23px;
		box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
		z-index: 1;

		-webkit-mask-image: radial-gradient(
			circle 50px at center top,
			transparent 50px,
			black 51px
		);
		mask-image: radial-gradient(
			circle 50px at center top,
			transparent 50px,
			black 51px
		);
		-webkit-mask-mode: alpha;
		mask-mode: alpha;
	}

	.card-inner {
		position: relative;
		z-index: 2;
		width: calc(100% - 2rem);
		max-width: 280px;
		margin: 0 auto;
		padding: 2.5rem 1.5rem 0.5rem;
		text-align: center;
	}
	.card-logo {
		position: absolute;
		/* 1rem (bottom) + 360px (alto del shape) - 40px (radio del logo) */
		bottom: calc(1rem + 14rem - 40px);
		left: 50%;
		transform: translateX(-50%);
		z-index: 2;
		width: 80px;
		height: 80px;
		background: #d6d6d6;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}
	.card-logo img {
		width: 75px;
		height: 75px;
		object-fit: contain;
	}
	.card-inner h3 {
		color: #06752e;
		font-size: 1rem;
		font-weight: 700;
		margin-bottom: 0;
	}
	.card-inner p {
		font-size: 0.9rem;
		color: #333;
		line-height: 1.4;
		margin-bottom: 0.6rem;
	}
	.cta-button {
		background: #06752e;
		color: white;
		font-weight: bold;
		text-decoration: none;
		padding: 0.6rem 1.2rem;
		border-radius: 2rem;
		display: inline-block;
		transition: background 0.3s ease;
	}
	.cta-button:hover {
		background: #1bae70;
	}

	@media (max-width: 992px) {
		#home-hero {
			flex-direction: column;
			gap: 1rem;
			padding: 1.5rem 1rem;
			margin: 2rem auto;
		}

		.hero-card.custom-bg-card {
			justify-content: center;
			align-items: center;
			padding-bottom: 1rem;
		}
		.card-inner {
			position: relative;
			z-index: 2;
			width: calc(100% - 2rem);
			max-width: 280px;
			margin: 9rem 0 0 1rem;
			padding: 0;
			text-align: center;
		}
		.card-shape {
			left: 50% !important;
			right: auto !important;
			transform: translateX(-50%);
			width: 90%;
			max-width: 300px;
		}
		.card-logo {
			left: 50% !important;
			transform: translate(-50%);
		}

		.card-inner {
			margin: 6rem 0 auto;
			padding-top: 2rem;
		}
	}

	@media (max-width: 700px) {
		#main-content {
			margin: 0 1rem;
		}
	}

	@media (max-width: 600px) {
		.hero-card {
			width: 100%;
			flex: none;
		}

		.hero-card.custom-bg-card {
			min-height: 300px;
			padding-bottom: 1rem;
		}
	}
</style>
