---
export const prerender = false;
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Usuarios">
	<section class="page">
		<header class="page-head">
			<div class="titles">
				<h1>Usuarios</h1>
				<p class="subtitle">
					Gestioná los usuarios registrados del sistema.
				</p>
			</div>
			<button id="newBtn" class="btn primary" type="button" disabled>
				Nuevo usuario
			</button>
		</header>

		<article class="table-card">
			<div class="toolbar">
				<input id="q" class="inp" placeholder="Buscar por email…" />
				<div class="spacer"></div>
				<select id="roleFilter" class="inp">
					<option value="">Todos los roles</option>
					<option value="editor">Editor</option>
					<option value="admin">Admin</option>
					<option value="owner">Owner</option>
				</select>
			</div>

			<table class="tbl users">
				<thead>
					<tr>
						<th>Email</th>
						<th>Rol</th>
						<th class="hidem">Estado</th>
						<th style="width:1%"></th>
					</tr>
				</thead>
				<tbody id="rows">
					<tr><td colspan="4" class="empty">Cargando…</td></tr>
				</tbody>
			</table>
		</article>

		<div class="pager">
			<button
				id="prev"
				class="btn ghost"
				type="button"
				aria-disabled="true"
				disabled>← Anterior</button
			>
			<span id="pageInfo" class="muted"></span>
			<button
				id="next"
				class="btn ghost"
				type="button"
				aria-disabled="true"
				disabled>Siguiente →</button
			>
		</div>

		<div id="status" class="status" role="status" aria-live="polite"></div>
	</section>

	<dialog id="userModal" class="modal">
		<form id="userForm" method="dialog" class="form card">
			<h3 id="userFormTitle">Nuevo usuario</h3>

			<input id="userId" type="hidden" />
			<label class="field">
				<span>Email</span>
				<input
					id="email"
					type="email"
					placeholder="usuario@dominio.com"
				/>
			</label>

			<label class="field">
				<span>Rol</span>
				<select id="role">
					<option value="editor">Editor</option>
					<option value="admin">Admin</option>
					<option value="owner">Owner</option>
				</select>
			</label>

			<footer class="modal-actions">
				<button class="btn ghost" type="button" id="cancelUser"
					>Cancelar</button
				>
				<button class="btn primary" type="submit" id="saveUser"
					>Guardar</button
				>
			</footer>
		</form>
	</dialog>

	<dialog id="resetModal" class="modal">
		<div class="card">
			<h3>Token de blanqueo</h3>
			<p>
				Compartí este token con el usuario para que inicie sesión y
				cambie su contraseña.
			</p>
			<div class="token-row">
				<input id="resetToken" class="token" readonly />
				<button id="copyToken" class="btn" type="button">Copiar</button>
			</div>
			<p id="tokenExp" class="muted"></p>
			<footer class="modal-actions">
				<button class="btn primary" id="closeReset" type="button"
					>Cerrar</button
				>
			</footer>
		</div>
	</dialog>

	<style>
		.page {
			max-width: 1100px;
			margin: 0 auto;
			padding: 1rem;
		}
		.page-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			background: color-mix(in oklab, #fff 92%, var(--bg));
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 0.9rem 1rem;
			position: static;
			top: 0;
			z-index: 10;
			backdrop-filter: blur(4px);
			margin-bottom: 1rem;
		}
		.titles h1 {
			margin: 0.05rem 0;
			color: var(--brand);
			font-size: 1.25rem;
		}
		.subtitle {
			margin: 0;
			color: var(--muted);
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}

		.toolbar {
			display: flex;
			gap: 0.6rem;
			align-items: center;
			margin: 0 0 0.8rem 0;
		}
		.spacer {
			flex: 1;
		}
		.inp {
			border: 1px solid var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			font: inherit;
			background: #fff;
			min-width: 220px;
		}
		.inp:focus {
			outline: none;
			box-shadow: 0 0 0 4px var(--ring);
		}

		.table-card {
			background: transparent;
			border: 0;
			border-radius: 0;
			padding: 0;
			overflow: visible;
		}

		.btn {
			appearance: none;
			border: 1px solid var(--border);
			background: #fff;
			color: #111;
			padding: 0.5rem 0.8rem;
			border-radius: 0.55rem;
			font-weight: 600;
			cursor: pointer;
		}
		.btn.primary {
			background: var(--accent);
			color: #fff;
			border-color: color-mix(in oklab, var(--accent), black 10%);
		}
		.btn.ghost:hover {
			background: #eef2f7;
		}

		:global(.tbl) {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			background: #fff;
			border: 1px solid var(--border, #e5e7eb);
			border-radius: 14px;
			overflow: hidden;
		}
		:global(.tbl thead th) {
			text-align: left;
			padding: 12px 16px;
			font-weight: 700;
			color: var(--brand, #0b2a66);
			background: #f8fafc;
			border-bottom: 1px solid var(--border, #e5e7eb);
			white-space: nowrap;
		}
		:global(.tbl tbody td) {
			padding: 14px 18px;
			vertical-align: middle;
			border-bottom: 1px solid #e9eef5;
			word-wrap: break-word;
		}
		:global(.tbl tbody tr:hover td) {
			background: #fbfdff;
		}
		:global(.tbl tbody tr:last-child td) {
			border-bottom: 0;
		}
		.empty {
			text-align: center;
			color: var(--muted);
			padding: 2rem 0;
		}

		:global(.badge) {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 999px;
			font-weight: 700;
			font-size: 0.82rem;
			border: 1px solid transparent;
		}
		:global(.badge.role-editor) {
			background: #eef2ff;
			color: #1e3a8a;
			border-color: color-mix(in oklab, var(--brand), white 70%);
		}
		:global(.badge.role-admin) {
			background: #fff7ed;
			color: #9a3412;
			border-color: #fed7aa;
		}
		:global(.badge.role-owner) {
			background: #ecfeff;
			color: #155e75;
			border-color: #bae6fd;
		}
		:global(.badge.active) {
			background: #ecfdf5;
			color: #065f46;
			border-color: #bbf7d0;
		}
		:global(.badge.inactive) {
			background: #fef2f2;
			color: #991b1b;
			border-color: #fecaca;
		}

		:global(th:last-child) {
			text-align: right;
		}
		:global(.td.actions) {
			white-space: nowrap;
			text-align: right;
			padding-right: 16px;
			width: 1%;
		}
		:global(.row-actions) {
			display: inline-flex;
			gap: 8px;
			align-items: center;
			flex-wrap: wrap;
			justify-content: flex-end;
		}

		:global(.kbtn) {
			appearance: none;
			border: 1px solid #e5e7eb;
			background: #fff;
			color: #111827;
			padding: 6px 10px;
			border-radius: 8px;
			font-weight: 700;
			cursor: pointer;
			text-decoration: none;
			line-height: 1;
		}
		:global(.kbtn:hover) {
			filter: brightness(0.98);
		}
		:global(.kbtn.ghost) {
			background: #f8fafc;
		}
		:global(.kbtn.danger) {
			border-color: #fca5a5;
			color: #991b1b;
		}
		:global(.kbtn.success) {
			border-color: #86efac;
			color: #166534;
		}
		:global(.kbtn.solid) {
			color: #fff;
			border-color: transparent;
		}
		:global(.kbtn.danger.solid) {
			background: #ef4444;
		}
		:global(.kbtn.success.solid) {
			background: #10b981;
		}

		.pager {
			display: flex;
			align-items: center;
			gap: 0.6rem;
			justify-content: center;
			padding: 0.9rem 0;
		}
		.muted {
			color: var(--muted);
		}

		.pager .btn:disabled,
		.pager .btn[disabled] {
			opacity: 0.5;
			cursor: not-allowed;
			pointer-events: none;
			filter: none;
			background: #f3f4f6;
			border-color: #e5e7eb;
			color: #9ca3af;
			box-shadow: none;
		}

		.modal {
			border: none;
			padding: 0;
			background: transparent;
			width: auto;
			max-width: 96vw;
		}
		.modal[open] {
			display: grid;
			place-items: center;
		}
		.modal::backdrop {
			background: rgba(0, 0, 0, 0.35);
			backdrop-filter: blur(2px);
		}

		.modal .card,
		.form.card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 1rem;
			box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18);
			width: min(520px, 96vw);
			max-width: 520px;
		}
		.modal h3 {
			margin: 0 0 0.5rem;
			color: var(--brand);
		}
		.form .field {
			display: grid;
			gap: 0.4rem;
			margin: 0.6rem 0;
		}
		.form input,
		.form select {
			border: 1px solid var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			font: inherit;
			background: #fff;
		}
		.form input:focus,
		.form select:focus {
			outline: none;
			box-shadow: 0 0 0 4px var(--ring);
		}
		.modal-actions {
			display: flex;
			gap: 0.6rem;
			justify-content: flex-end;
			margin-top: 0.8rem;
		}
		.token-row {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.token {
			width: 100%;
			border: 1px dashed var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			background: #fff;
			font-family: ui-monospace, Menlo, Consolas, monospace;
		}

		@media (max-width: 820px) {
			.inp {
				min-width: 130px;
			}
			.hidem {
				display: none;
			}
			:global(.row-actions) {
				justify-content: flex-start;
			}
		}

		.status {
			position: fixed;
			right: 18px;
			bottom: 18px;
			z-index: 70;
			display: none;
			min-width: 180px;
			background: var(--card);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 0.55rem 0.8rem;
			box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
			font-weight: 600;
		}
		.status.show {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}
		.status.ok {
			border-color: color-mix(in oklab, var(--accent), white 60%);
		}
		.status.err {
			background: #fff1f2;
			color: #7f1d1d;
			border-color: #fecaca;
		}
		.status.err::before {
			content: "⚠";
			font-size: 1rem;
			line-height: 1;
			opacity: 0.9;
		}
	</style>

	<script type="module" src="/scripts/admin-usuarios.js"></script>
</DashboardLayout>
