---
export const prerender = false;
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Usuarios">
	<section class="page">
		<header class="page-head">
			<div class="titles">
				<h1>Usuarios</h1>
				<p class="subtitle">
					Gestioná los usuarios registrados del sistema.
				</p>
			</div>
			<button id="newBtn" class="btn primary" type="button" disabled>
				Nuevo usuario
			</button>
		</header>

		<article class="table-card">
			<div class="toolbar">
				<input id="q" class="inp" placeholder="Buscar por email…" />
				<div class="spacer"></div>
				<select id="roleFilter" class="inp">
					<option value="">Todos los roles</option>
					<option value="editor">Editor</option>
					<option value="admin">Admin</option>
					<option value="owner">Owner</option>
				</select>
			</div>

			<table class="tbl users">
				<thead>
					<tr>
						<th>Email</th>
						<th>Rol</th>
						<th class="hidem">Estado</th>
						<th style="width:1%"></th>
					</tr>
				</thead>
				<tbody id="rows">
					<tr><td colspan="4" class="empty">Cargando…</td></tr>
				</tbody>
			</table>
		</article>

		<div class="pager">
			<button
				id="prev"
				class="btn ghost"
				type="button"
				aria-disabled="true"
				disabled>← Anterior</button
			>
			<span id="pageInfo" class="muted"></span>
			<button
				id="next"
				class="btn ghost"
				type="button"
				aria-disabled="true"
				disabled>Siguiente →</button
			>
		</div>

		<div id="status" class="status" role="status" aria-live="polite"></div>
	</section>

	<dialog id="userModal" class="modal">
		<form id="userForm" method="dialog" class="form card">
			<h3 id="userFormTitle">Nuevo usuario</h3>

			<input id="userId" type="hidden" />
			<label class="field">
				<span>Email</span>
				<input
					id="email"
					type="email"
					placeholder="usuario@dominio.com"
				/>
			</label>

			<label class="field">
				<span>Rol</span>
				<select id="role">
					<option value="editor">Editor</option>
					<option value="admin">Admin</option>
					<option value="owner">Owner</option>
				</select>
			</label>

			<footer class="modal-actions">
				<button class="btn ghost" type="button" id="cancelUser"
					>Cancelar</button
				>
				<button class="btn primary" type="submit" id="saveUser"
					>Guardar</button
				>
			</footer>
		</form>
	</dialog>

	<dialog id="resetModal" class="modal">
		<div class="card">
			<h3>Token de blanqueo</h3>
			<p>
				Compartí este token con el usuario para que inicie sesión y
				cambie su contraseña.
			</p>
			<div class="token-row">
				<input id="resetToken" class="token" readonly />
				<button id="copyToken" class="btn" type="button">Copiar</button>
			</div>
			<p id="tokenExp" class="muted"></p>
			<footer class="modal-actions">
				<button class="btn primary" id="closeReset" type="button"
					>Cerrar</button
				>
			</footer>
		</div>
	</dialog>

	<style>
		.page {
			max-width: 1100px;
			margin: 0 auto;
			padding: 1rem;
		}
		.page-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			background: color-mix(in oklab, #fff 92%, var(--bg));
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 0.9rem 1rem;
			position: static;
			top: 0;
			z-index: 10;
			backdrop-filter: blur(4px);
			margin-bottom: 1rem;
		}
		.titles h1 {
			margin: 0.05rem 0;
			color: var(--brand);
			font-size: 1.25rem;
		}
		.subtitle {
			margin: 0;
			color: var(--muted);
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}

		.toolbar {
			display: flex;
			gap: 0.6rem;
			align-items: center;
			margin: 0 0 0.8rem 0;
		}
		.spacer {
			flex: 1;
		}
		.inp {
			border: 1px solid var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			font: inherit;
			background: #fff;
			min-width: 220px;
		}
		.inp:focus {
			outline: none;
			box-shadow: 0 0 0 4px var(--ring);
		}

		.table-card {
			background: transparent;
			border: 0;
			border-radius: 0;
			padding: 0;
			overflow: visible;
		}

		.btn {
			appearance: none;
			border: 1px solid var(--border);
			background: #fff;
			color: #111;
			padding: 0.5rem 0.8rem;
			border-radius: 0.55rem;
			font-weight: 600;
			cursor: pointer;
		}
		.btn.primary {
			background: var(--accent);
			color: #fff;
			border-color: color-mix(in oklab, var(--accent), black 10%);
		}
		.btn.ghost:hover {
			background: #eef2f7;
		}

		:global(.tbl) {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			background: #fff;
			border: 1px solid var(--border, #e5e7eb);
			border-radius: 14px;
			overflow: hidden;
		}
		:global(.tbl thead th) {
			text-align: left;
			padding: 12px 16px;
			font-weight: 700;
			color: var(--brand, #0b2a66);
			background: #f8fafc;
			border-bottom: 1px solid var(--border, #e5e7eb);
			white-space: nowrap;
		}
		:global(.tbl tbody td) {
			padding: 14px 18px;
			vertical-align: middle;
			border-bottom: 1px solid #e9eef5;
			word-wrap: break-word;
		}
		:global(.tbl tbody tr:hover td) {
			background: #fbfdff;
		}
		:global(.tbl tbody tr:last-child td) {
			border-bottom: 0;
		}
		.empty {
			text-align: center;
			color: var(--muted);
			padding: 2rem 0;
		}

		:global(.badge) {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 999px;
			font-weight: 700;
			font-size: 0.82rem;
			border: 1px solid transparent;
		}
		:global(.badge.role-editor) {
			background: #eef2ff;
			color: #1e3a8a;
			border-color: color-mix(in oklab, var(--brand), white 70%);
		}
		:global(.badge.role-admin) {
			background: #fff7ed;
			color: #9a3412;
			border-color: #fed7aa;
		}
		:global(.badge.role-owner) {
			background: #ecfeff;
			color: #155e75;
			border-color: #bae6fd;
		}
		:global(.badge.active) {
			background: #ecfdf5;
			color: #065f46;
			border-color: #bbf7d0;
		}
		:global(.badge.inactive) {
			background: #fef2f2;
			color: #991b1b;
			border-color: #fecaca;
		}

		:global(th:last-child) {
			text-align: right;
		}
		:global(.td.actions) {
			white-space: nowrap;
			text-align: right;
			padding-right: 16px;
			width: 1%;
		}
		:global(.row-actions) {
			display: inline-flex;
			gap: 8px;
			align-items: center;
			flex-wrap: wrap;
			justify-content: flex-end;
		}

		:global(.kbtn) {
			appearance: none;
			border: 1px solid #e5e7eb;
			background: #fff;
			color: #111827;
			padding: 6px 10px;
			border-radius: 8px;
			font-weight: 700;
			cursor: pointer;
			text-decoration: none;
			line-height: 1;
		}
		:global(.kbtn:hover) {
			filter: brightness(0.98);
		}
		:global(.kbtn.ghost) {
			background: #f8fafc;
		}
		:global(.kbtn.danger) {
			border-color: #fca5a5;
			color: #991b1b;
		}
		:global(.kbtn.success) {
			border-color: #86efac;
			color: #166534;
		}
		:global(.kbtn.solid) {
			color: #fff;
			border-color: transparent;
		}
		:global(.kbtn.danger.solid) {
			background: #ef4444;
		}
		:global(.kbtn.success.solid) {
			background: #10b981;
		}

		.pager {
			display: flex;
			align-items: center;
			gap: 0.6rem;
			justify-content: center;
			padding: 0.9rem 0;
		}
		.muted {
			color: var(--muted);
		}

		.pager .btn:disabled,
		.pager .btn[disabled] {
			opacity: 0.5;
			cursor: not-allowed;
			pointer-events: none;
			filter: none;
			background: #f3f4f6;
			border-color: #e5e7eb;
			color: #9ca3af;
			box-shadow: none;
		}

		.modal {
			border: none;
			padding: 0;
			background: transparent;
			width: auto;
			max-width: 96vw;
		}
		.modal[open] {
			display: grid;
			place-items: center;
		}
		.modal::backdrop {
			background: rgba(0, 0, 0, 0.35);
			backdrop-filter: blur(2px);
		}

		.modal .card,
		.form.card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 1rem;
			box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18);
			width: min(520px, 96vw);
			max-width: 520px;
		}
		.modal h3 {
			margin: 0 0 0.5rem;
			color: var(--brand);
		}
		.form .field {
			display: grid;
			gap: 0.4rem;
			margin: 0.6rem 0;
		}
		.form input,
		.form select {
			border: 1px solid var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			font: inherit;
			background: #fff;
		}
		.form input:focus,
		.form select:focus {
			outline: none;
			box-shadow: 0 0 0 4px var(--ring);
		}
		.modal-actions {
			display: flex;
			gap: 0.6rem;
			justify-content: flex-end;
			margin-top: 0.8rem;
		}
		.token-row {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.token {
			width: 100%;
			border: 1px dashed var(--border);
			border-radius: 0.55rem;
			padding: 0.55rem 0.7rem;
			background: #fff;
			font-family: ui-monospace, Menlo, Consolas, monospace;
		}

		@media (max-width: 820px) {
			.inp {
				min-width: 130px;
			}
			.hidem {
				display: none;
			}
			:global(.row-actions) {
				justify-content: flex-start;
			}
		}

		.status {
			position: fixed;
			right: 18px;
			bottom: 18px;
			z-index: 70;
			display: none;
			min-width: 180px;
			background: var(--card);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 0.55rem 0.8rem;
			box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
			font-weight: 600;
		}
		.status.show {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}
		.status.ok {
			border-color: color-mix(in oklab, var(--accent), white 60%);
		}
		.status.err {
			background: #fff1f2;
			color: #7f1d1d;
			border-color: #fecaca;
		}
		.status.err::before {
			content: "⚠";
			font-size: 1rem;
			line-height: 1;
			opacity: 0.9;
		}
	</style>

	<script type="module">
		import {
			apiGet,
			apiPost,
			apiPut,
			getErrorInfo,
			toErrorText,
			clientGetMe,
		} from "/src/lib/api";
		import { makeToaster, markInvalid } from "/src/lib/admin-uploader";

		const toast = makeToaster("status", { okMs: 1600, errMs: 5000 });

		let me = null;
		let canEdit = false;

		let page = 1;
		const pageSize = 10;
		let total = 0;
		let q = "";
		let roleFilter = "";
		let items = [];

		const rowsEl = document.getElementById("rows");
		const pageInfo = document.getElementById("pageInfo");
		const prevBtn = document.getElementById("prev");
		const nextBtn = document.getElementById("next");

		const newBtn = document.getElementById("newBtn");
		const qEl = document.getElementById("q");
		const roleFilterEl = document.getElementById("roleFilter");

		const userModal = document.getElementById("userModal");
		const userForm = document.getElementById("userForm");
		const userFormTitle = document.getElementById("userFormTitle");
		const userIdEl = document.getElementById("userId");
		const emailEl = document.getElementById("email");
		const roleEl = document.getElementById("role");
		const cancelUser = document.getElementById("cancelUser");

		const resetModal = document.getElementById("resetModal");
		const resetTokenEl = document.getElementById("resetToken");
		const copyTokenBtn = document.getElementById("copyToken");
		const tokenExpEl = document.getElementById("tokenExp");
		const closeReset = document.getElementById("closeReset");

		function isPrivileged(role) {
			return role === "admin" || role === "owner";
		}
		function isUserActive(u) {
			if (typeof u?.active === "boolean") return u.active;
			const st = (u?.status || "").toLowerCase();
			if (!st) return true;
			return st !== "blocked";
		}
		function statusBadge(u) {
			const st = (
				u?.status || (isUserActive(u) ? "active" : "blocked")
			).toLowerCase();
			if (st === "blocked")
				return '<span class="badge inactive">Bloqueado</span>';
			return '<span class="badge active">Activo</span>';
		}
		function roleBadge(role) {
			return `<span class="badge role-${role}">${role}</span>`;
		}
		function clearFormErrors() {
			[emailEl, roleEl].forEach((el) => {
				el?.classList.remove("invalid", "is-invalid");
				const label = el.closest("label") || el.parentElement;
				label?.querySelectorAll(".err-tip")?.forEach((n) => n.remove());
				el.removeAttribute("aria-invalid");
				el.removeAttribute("aria-describedby");
			});
		}

		boot();
		async function boot() {
			try {
				me = await clientGetMe();
				canEdit = isPrivileged(me?.user?.role || "");
				if (canEdit) newBtn?.removeAttribute("disabled");
				bindEvents();
				await loadUsers();
			} catch (e) {
				toast.show("No se pudo cargar usuarios", "err");
				console.error(e);
			}
		}

		function bindEvents() {
			qEl?.addEventListener(
				"input",
				debounce(() => {
					q = (qEl.value || "").trim();
					page = 1;
					loadUsers();
				}, 300)
			);

			roleFilterEl?.addEventListener("change", () => {
				roleFilter = roleFilterEl.value;
				page = 1;
				loadUsers();
			});

			prevBtn?.addEventListener("click", () => {
				if (page > 1) {
					page--;
					loadUsers();
				}
			});
			nextBtn?.addEventListener("click", () => {
				const maxPage = Math.max(1, Math.ceil(total / pageSize));
				if (page < maxPage) {
					page++;
					loadUsers();
				}
			});

			newBtn?.addEventListener("click", () => openUserModal());

			cancelUser?.addEventListener("click", () => userModal.close());
			userForm?.addEventListener("submit", onSubmitUser);

			userModal?.addEventListener("click", (e) => {
				if (e.target === userModal) userModal.close();
			});
			resetModal?.addEventListener("click", (e) => {
				if (e.target === resetModal) resetModal.close();
			});

			copyTokenBtn?.addEventListener("click", async () => {
				try {
					await navigator.clipboard.writeText(resetTokenEl.value);
					toast.show("Copiado ✅", "ok");
				} catch {
					toast.show("No se pudo copiar", "err");
				}
			});
			closeReset?.addEventListener("click", () => resetModal.close());
		}
		async function loadUsers() {
			try {
				rowsEl.innerHTML = `<tr><td colspan="4" class="empty">Cargando…</td></tr>`;
				const qs = new URLSearchParams({
					page: String(page),
					pageSize: String(pageSize),
					...(q ? { q } : {}),
					...(roleFilter ? { role: roleFilter } : {}),
				}).toString();

				const res = await apiGet(`/v1/users?${qs}`);
				if (!res.ok) throw new Error(await res.text());
				const data = await res.json();

				total = data.total || 0;
				items = Array.isArray(data.items) ? data.items : [];

				if (!items.length) {
					rowsEl.innerHTML = `<tr><td colspan="4" class="empty">Sin resultados</td></tr>`;
				} else {
					rowsEl.innerHTML = items.map((u) => renderRow(u)).join("");

					rowsEl
						.querySelectorAll("[data-action='edit']")
						.forEach((btn) =>
							btn.addEventListener("click", () =>
								openUserModal(
									btn.dataset.id,
									items.find(
										(x) =>
											String(x.id) ===
											String(btn.dataset.id)
									)
								)
							)
						);
					rowsEl
						.querySelectorAll(".act-block")
						.forEach((btn) =>
							btn.addEventListener("click", () =>
								onToggleStatus(btn.dataset.id, false)
							)
						);
					rowsEl
						.querySelectorAll(".act-unblock")
						.forEach((btn) =>
							btn.addEventListener("click", () =>
								onToggleStatus(btn.dataset.id, true)
							)
						);
					rowsEl
						.querySelectorAll(".act-reset")
						.forEach((btn) =>
							btn.addEventListener("click", () =>
								onResetToken(btn.dataset.id)
							)
						);
				}

				const maxPage = Math.max(1, Math.ceil(total / pageSize));
				pageInfo.textContent = `Página ${page} de ${maxPage} • ${total} usuarios`;

				const prevDisabled = page <= 1;
				const nextDisabled = page >= maxPage;
				prevBtn.disabled = prevDisabled;
				nextBtn.disabled = nextDisabled;
				prevBtn.setAttribute("aria-disabled", String(prevDisabled));
				nextBtn.setAttribute("aria-disabled", String(nextDisabled));
			} catch (e) {
				console.error(e);
				rowsEl.innerHTML = `<tr><td colspan="4" class="empty">Error cargando usuarios</td></tr>`;
			}
		}

		function renderRow(u) {
			const active = isUserActive(u);

			const blockBtn = active
				? `<button class="kbtn danger solid act-block" data-id="${u.id}">Bloquear</button>`
				: `<button class="kbtn success solid act-unblock" data-id="${u.id}">Desbloquear</button>`;

			const actions = canEdit
				? `<div class="row-actions">
         				<button class="kbtn" data-action="edit" data-id="${u.id}">Editar</button>
         				${blockBtn}
         				<button class="kbtn ghost act-reset" data-id="${u.id}">Blanquear</button>
       				</div>`
				: `<span class="muted">—</span>`;

			return `<tr>
				<td>${escapeHtml(u.email || "")}</td>
				<td>${roleBadge(u.role || "editor")}</td>
				<td class="hidem">${statusBadge(u)}</td>
				<td class="td actions">${actions}</td>
			</tr>`;
		}

		let modalOriginal = { email: "", role: "editor" };

		function openUserModal(id = null, data = null) {
			clearFormErrors();
			userIdEl.value = id ? String(id) : "";
			emailEl.value = data?.email || "";
			roleEl.value = data?.role || "editor";

			modalOriginal = { email: emailEl.value, role: roleEl.value };

			const meId = me?.user?.id ? String(me.user.id) : null;
			const isSelf = meId && id && String(id) === meId;
			if (isSelf && me?.user?.role !== "owner") {
				roleEl.setAttribute("disabled", "true");
			} else {
				roleEl.removeAttribute("disabled");
			}

			userFormTitle.textContent = id ? "Editar usuario" : "Nuevo usuario";
			if (!canEdit) return;
			userModal.showModal();
		}

		async function onSubmitUser(e) {
			e.preventDefault();
			clearFormErrors();

			const id = userIdEl.value || null;
			const email = (emailEl.value || "").trim();
			const role = roleEl.value || "editor";

			if (!email) {
				markInvalid(emailEl, "El email es obligatorio");
				return;
			}
			if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
				markInvalid(emailEl, "Email inválido");
				return;
			}

			try {
				if (!id) {
					toast.show("Creando…");
					const res = await apiPost(`/v1/users`, { email, role });
					if (!res.ok) {
						const { text, fieldErrors } = await getErrorInfo(res);
						fieldErrors.forEach((fe) => {
							const el =
								fe.field === "email"
									? emailEl
									: fe.field === "role"
										? roleEl
										: null;
							if (el)
								markInvalid(el, fe.message || "Dato inválido");
						});
						return toast.show(text || "Error", "err");
					}
					toast.show("Creado ✅", "ok");
					userModal.close();
					await loadUsers();
					return;
				}

				const meId = me?.user?.id ? String(me.user.id) : null;
				const isSelf = meId && String(id) === meId;

				if (email !== modalOriginal.email) {
					toast.show("Actualizando email…");
					const r = await apiPut(`/v1/users/${id}/email`, { email });
					if (!r.ok) {
						const { text, fieldErrors } = await getErrorInfo(r);
						fieldErrors.forEach(
							(fe) =>
								fe.field === "email" &&
								markInvalid(
									emailEl,
									fe.message || "Dato inválido"
								)
						);
						return toast.show(
							text || "No se pudo actualizar el email",
							"err"
						);
					}
				}

				if (role !== modalOriginal.role) {
					if (!canEdit)
						return toast.show(
							"No autorizado para cambiar rol",
							"err"
						);

					if (isSelf && me?.user?.role !== "owner") {
						return toast.show(
							"No podés cambiar tu propio rol (salvo owner)",
							"err"
						);
					}
					toast.show("Actualizando rol…");
					const r = await apiPut(`/v1/users/${id}/role`, { role });
					if (!r.ok) {
						const { text, fieldErrors } = await getErrorInfo(r);
						fieldErrors.forEach(
							(fe) =>
								fe.field === "role" &&
								markInvalid(
									roleEl,
									fe.message || "Dato inválido"
								)
						);
						return toast.show(
							text || "No se pudo actualizar el rol",
							"err"
						);
					}
				}

				toast.show("Guardado ✅", "ok");
				userModal.close();
				await loadUsers();
			} catch (err) {
				console.error(err);
				toast.show(toErrorText(err), "err");
			}
		}

		async function onToggleStatus(id, nextActive) {
			if (!canEdit) return toast.show("No autorizado", "err");

			const u = items.find((x) => String(x.id) === String(id));
			if (!u) return;

			const meId = me?.user?.id ? String(me.user.id) : null;
			const isSelf = meId && String(u.id) === meId;
			if (isSelf)
				return toast.show("No podés bloquearte a vos mismo", "err");
			if (u.role === "owner" && nextActive === false)
				return toast.show("No se puede bloquear un Owner", "err");

			const ok = confirm(
				`${nextActive ? "Desbloquear" : "Bloquear"} a ${u.email}?`
			);
			if (!ok) return;

			try {
				toast.show(nextActive ? "Desbloqueando…" : "Bloqueando…");
				const status = nextActive ? "active" : "blocked";
				const res = await apiPut(`/v1/users/${id}/status`, { status });
				if (!res.ok) {
					const { text } = await getErrorInfo(res);
					return toast.show(
						text || "No se pudo actualizar el estado",
						"err"
					);
				}
				await loadUsers();
				toast.show("Estado actualizado ✅", "ok");
			} catch (e) {
				console.error(e);
				toast.show("No se pudo actualizar el estado", "err");
			}
		}

		async function onResetToken(id) {
			if (!canEdit) return;
			const ok = confirm("¿Generar token de blanqueo para este usuario?");
			if (!ok) return;
			try {
				toast.show("Generando token…");
				const res = await apiPost(`/v1/users/${id}/recovery-token`);
				if (!res.ok) {
					const { text } = await getErrorInfo(res);
					toast.show(text || "No se pudo generar el token", "err");
					return;
				}
				const { token, expiresAt } = await res.json();
				resetTokenEl.value = token || "";
				tokenExpEl.textContent = expiresAt
					? "Vence: " + new Date(expiresAt).toLocaleString()
					: "";
				resetModal.showModal();
				toast.clear();
			} catch (e) {
				console.error(e);
				toast.show("No se pudo generar el token", "err");
			}
		}

		function debounce(fn, ms = 300) {
			let t;
			return (...a) => {
				clearTimeout(t);
				t = setTimeout(() => fn(...a), ms);
			};
		}
		function escapeHtml(str) {
			return (str || "").replace(
				/[&<>"']/g,
				(m) =>
					({
						"&": "&amp;",
						"<": "&lt;",
						">": "&gt;",
						'"': "&quot;",
						"'": "&#039;",
					})[m]
			);
		}
	</script>
</DashboardLayout>
