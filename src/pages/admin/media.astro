---
export const prerender = false;
import DashboardLayout from "../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Medios">
	<section class="page medialib">
		<header class="page-head">
			<div class="titles">
				<h1>Biblioteca de medios</h1>
				<p class="subtitle">
					Imágenes y videos organizados por carpetas.
				</p>
			</div>
			<div class="actions">
				<!-- <div
					class="seg used-filter"
					role="group"
					aria-label="Filtrar por uso"
				>
					<button class="kbtn seg-btn active" data-used="all"
						>Todos</button
					>
					<button class="kbtn seg-btn" data-used="true">En uso</button
					>
					<button class="kbtn seg-btn" data-used="false"
						>Libres</button
					>
				</div> -->
				<button
					id="reload"
					class="icon-btn"
					type="button"
					aria-label="Recargar"
					title="Recargar"
				>
					<svg viewBox="0 0 24 24" aria-hidden="true">
						<path
							d="M20 12a8 8 0 1 1-2.34-5.66"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"></path>
						<path
							d="M20 4v6h-6"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"></path>
					</svg>
				</button>
			</div>
		</header>

		<div class="media-shell">
			<aside class="folders">
				<div class="folders-head">Carpetas</div>
				<nav id="folderTree" class="tree"></nav>
			</aside>

			<div class="media-main">
				<div id="grid" class="media-grid"></div>

				<footer class="pager">
					<button id="prev" class="btn ghost" disabled
						>← Anterior</button
					>
					<span id="info" class="muted"></span>
					<button id="next" class="btn ghost" disabled
						>Siguiente →</button
					>
				</footer>
			</div>
		</div>

		<div id="toast" class="toast" role="status" aria-live="polite"></div>
	</section>

	<dialog id="previewModal" class="modal">
		<div class="card">
			<h3 id="previewTitle">Vista previa</h3>
			<div class="preview">
				<div id="previewBody" class="preview-body"></div>
				<div id="previewMeta" class="detail"></div>
			</div>
			<footer class="modal-actions">
				<button id="previewOpen" class="kbtn">Abrir en pestaña</button>
				<button id="previewCopy" class="kbtn">Copiar URL</button>
				<button id="previewClose" class="btn primary" type="button"
					>Cerrar</button
				>
			</footer>
		</div>
	</dialog>

	<style>
		.page {
			max-width: 1100px;
			margin: 0 auto;
			padding: 1rem;
			display: grid;
			grid-template-rows: auto 1fr;
			gap: 1rem;
		}
		.page-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			background: color-mix(in oklab, #fff 92%, var(--bg));
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 0.9rem 1rem;
			margin-bottom: 0;
		}
		.titles h1 {
			margin: 0.05rem 0;
			color: var(--brand);
			font-size: 1.25rem;
		}
		.subtitle {
			margin: 0;
			color: var(--muted);
		}

		:global(.medialib .media-shell) {
			display: grid;
			grid-template-columns: 260px 1fr;
			gap: 1rem;
			align-items: start;
		}
		@media (max-width: 980px) {
			:global(.medialib .media-shell) {
				grid-template-columns: 1fr;
			}
		}

		:global(.medialib .folders) {
			background: #fff;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 0.6rem;
			position: sticky;
			top: calc(var(--topbar-h, 56px) + 0.75rem);
			align-self: start;
			max-height: calc(100dvh - var(--topbar-h, 56px) - 2rem);
			overflow: auto;
		}
		:global(.medialib .folders-head) {
			font-weight: 700;
			color: var(--brand);
			padding: 0.3rem 0.35rem 0.2rem;
		}
		:global(.medialib .tree) {
			list-style: none;
			margin: 0.2rem 0 0;
			padding: 0 0.2rem;
		}
		:global(.medialib .tree ul) {
			list-style: none;
			margin: 0.25rem 0 0.25rem 0.9rem;
			padding: 0;
		}
		:global(.medialib .node) {
			appearance: none;
			border: 1px solid var(--border);
			background: #fff;
			color: #1f2328;
			font-weight: 600;
			border-radius: 0.55rem;
			padding: 0.42rem 0.55rem;
			width: 100%;
			text-align: left;
			cursor: pointer;
			display: flex;
			gap: 0.45rem;
			align-items: center;
			justify-content: flex-start;
		}
		:global(.medialib .node:hover) {
			background: #eef2f7;
		}
		:global(.medialib .node.active) {
			background: #eef3ff;
			color: #0b2a66;
			border-color: color-mix(in oklab, var(--brand), white 70%);
			box-shadow: inset 0 0 0 1px
				color-mix(in oklab, var(--brand), white 78%);
		}
		:global(.medialib .chev) {
			width: 1rem;
			text-align: center;
			opacity: 0.7;
		}
		:global(.medialib .leaf) {
			width: 0.55rem;
			height: 0.55rem;
			border-radius: 999px;
			background: #9aa1ab;
			opacity: 0.7;
		}

		:global(.medialib .media-main) {
			min-width: 0;
		}
		:global(.medialib .media-grid) {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
			gap: 0.9rem;
		}
		:global(.medialib .media-card) {
			background: #fff;
			border: 1px solid var(--border);
			border-radius: 14px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			transition: transform 0.08s ease;
		}
		:global(.medialib .media-card:active) {
			transform: scale(0.995);
		}

		:global(.medialib .thumb) {
			width: 100%;
			height: 200px;
			background: #f3f5f7;
			display: grid;
			place-items: center;
			overflow: hidden;
		}
		:global(.medialib .thumb img),
		:global(.medialib .thumb video) {
			max-width: 350px;
			width: auto;
			height: auto;
			object-fit: cover;
			display: block;
			border-radius: 6px;
		}

		:global(.medialib .meta) {
			padding: 0.6rem 0.7rem;
			display: grid;
			gap: 0.35rem;
			font-size: 0.92rem;
			color: #222;
		}
		:global(.medialib .name) {
			font-weight: 700;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		:global(.medialib .sub) {
			color: var(--muted);
			font-size: 0.85rem;
		}
		:global(.medialib .row) {
			display: flex;
			gap: 0.4rem;
			flex-wrap: wrap;
			align-items: center;
		}
		:global(.medialib .tag) {
			background: #f3f5f7;
			border: 1px solid var(--border);
			border-radius: 0.5rem;
			padding: 0.2rem 0.45rem;
			font-size: 0.8rem;
		}

		:global(.badge) {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 999px;
			font-weight: 700;
			font-size: 0.82rem;
			border: 1px solid transparent;
		}
		:global(.badge.is-used) {
			background: #ecfdf5;
			color: #065f46;
			border-color: #bbf7d0;
		}
		:global(.badge.is-unused) {
			background: #f1f5f9;
			color: #334155;
			border-color: #e5e7eb;
		}

		:global(.medialib .ops) {
			display: flex;
			gap: 0.4rem;
			margin-top: 0.35rem;
		}
		:global(.kbtn) {
			appearance: none;
			border: 1px solid #e5e7eb;
			background: #fff;
			color: #111827;
			padding: 6px 10px;
			border-radius: 8px;
			font-weight: 700;
			cursor: pointer;
			text-decoration: none;
			line-height: 1;
		}
		:global(.kbtn:hover) {
			filter: brightness(0.98);
		}
		:global(.kbtn.danger) {
			border-color: #fca5a5;
			color: #991b1b;
		}
		:global(.kbtn.danger.solid) {
			background: #ef4444;
			color: #fff;
			border-color: transparent;
		}

		.pager {
			display: flex;
			align-items: center;
			gap: 0.6rem;
			justify-content: center;
			padding: 0.9rem 0;
		}
		.muted {
			color: var(--muted);
		}
		.toast {
			position: fixed;
			right: 18px;
			bottom: 18px;
			z-index: 70;
			display: none;
			min-width: 180px;
			background: var(--card);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 0.55rem 0.8rem;
			box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
			font-weight: 600;
		}
		.toast.show {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}

		.modal {
			border: none;
			padding: 0;
			background: transparent;
			width: auto;
			max-width: 96vw;
		}
		.modal[open] {
			display: grid;
			place-items: center;
		}
		.modal::backdrop {
			background: rgba(0, 0, 0, 0.35);
			backdrop-filter: blur(2px);
		}
		.modal .card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 1rem;
			box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18);
			width: min(880px, 96vw);
			max-width: 880px;
		}
		.modal h3 {
			margin: 0 0 0.5rem;
			color: var(--brand);
		}
		.preview {
			display: grid;
			gap: 0.7rem;
		}
		.preview-body {
			display: grid;
			place-items: center;
			background: #f8fafc;
			border: 1px solid var(--border);
			border-radius: 10px;
			min-height: 360px;
			padding: 0.6rem;
			overflow: auto;
		}
		.preview-body img,
		.preview-body video {
			max-width: 100%;
			max-height: 68vh;
			object-fit: contain;
			border-radius: 8px;
		}
		.detail {
			display: grid;
			gap: 0.35rem;
		}
		.detail .row {
			display: grid;
			grid-template-columns: 140px 1fr;
			gap: 0.5rem;
		}
		.detail .row b {
			color: var(--muted);
			font-weight: 700;
		}
		.modal-actions {
			display: flex;
			gap: 0.6rem;
			justify-content: flex-end;
			margin-top: 0.7rem;
		}
		@media (max-width: 820px) {
			.detail .row {
				grid-template-columns: 1fr;
			}
		}

		:global(.medialib .seg) {
			display: inline-flex;
			gap: 0;
			border: 1px solid var(--border);
			border-radius: 10px;
			overflow: hidden;
			background: #fff;
		}
		:global(.medialib .seg-btn) {
			border: 0;
			border-right: 1px solid var(--border);
			border-radius: 0;
			padding: 0.45rem 0.7rem;
			font-weight: 700;
			background: #fff;
		}
		:global(.medialib .seg-btn:last-child) {
			border-right: 0;
		}
		:global(.medialib .seg-btn.active) {
			background: #eef3ff;
			color: #0b2a66;
		}
		/* ====== Icon button (Recargar) ====== */
		.icon-btn {
			appearance: none;
			border: 1px solid var(--border);
			background: #fff;
			color: #111827;
			width: 40px;
			height: 40px;
			border-radius: 12px;
			display: inline-grid;
			place-items: center;
			cursor: pointer;
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
			transition:
				transform 0.08s ease,
				filter 0.15s ease,
				background 0.15s ease;
		}
		.icon-btn svg {
			width: 20px;
			height: 20px;
		}
		.icon-btn:hover {
			background: #eef3ff;
			filter: brightness(0.99);
		}
		.icon-btn:active {
			transform: scale(0.98);
		}
		.icon-btn:focus-visible {
			outline: 2px solid color-mix(in oklab, var(--brand), white 55%);
			outline-offset: 2px;
		}

		/* ====== Pager buttons (Anterior/Siguiente) ====== */
		.pager .btn.ghost {
			border: 1px solid var(--border);
			background: #fff;
			color: #111827;
			border-radius: 12px;
			padding: 0.55rem 0.85rem;
			font-weight: 800;
			transition:
				transform 0.08s ease,
				background 0.15s ease,
				filter 0.15s ease;
		}
		.pager .btn.ghost:hover:not([disabled]) {
			background: #eef3ff;
			filter: brightness(0.99);
		}
		.pager .btn.ghost:active:not([disabled]) {
			transform: scale(0.99);
		}
		.pager .btn.ghost[disabled] {
			opacity: 0.55;
			cursor: not-allowed;
			filter: grayscale(0.1);
		}
	</style>

	<script type="module">
		import { apiFetch } from "/src/lib/api.ts";

		const FOLDERS_URL = "/v1/media/folders";
		const ASSETS_URL = "/v1/media/assets";
		const DELETE_URL = "/v1/media/asset";

		const treeEl = document.getElementById("folderTree");
		const grid = document.getElementById("grid");
		const reloadBtn = document.getElementById("reload");
		const prevBtn = document.getElementById("prev");
		const nextBtn = document.getElementById("next");
		const info = document.getElementById("info");
		const toast = document.getElementById("toast");
		const usedSeg = document.querySelector(".used-filter");

		const previewModal = document.getElementById("previewModal");
		const previewTitle = document.getElementById("previewTitle");
		const previewBody = document.getElementById("previewBody");
		const previewMeta = document.getElementById("previewMeta");
		const previewCopy = document.getElementById("previewCopy");
		const previewOpen = document.getElementById("previewOpen");
		const previewClose = document.getElementById("previewClose");

		function toastMsg(msg) {
			toast.textContent = msg;
			toast.className = "toast show";
			setTimeout(() => (toast.className = "toast"), 1600);
		}

		const state = {
			folder: "all",
			cursor: null,
			prevStack: [],
			totalApprox: 0,
			lastItems: [],
			used: "all",
		};

		function buildTree(folders) {
			const root = { children: new Map() };
			const labelByPath = new Map(
				folders.map((f) => [f.path, f.name || f.path.split("/").pop()])
			);
			for (const f of folders) {
				const parts = String(f.path).split("/");
				let node = root;
				let acc = [];
				for (let i = 0; i < parts.length; i++) {
					const part = parts[i];
					acc.push(part);
					const p = acc.join("/");
					if (!node.children.has(part)) {
						node.children.set(part, {
							key: p,
							label: labelByPath.get(p) || part,
							children: new Map(),
						});
					}
					node = node.children.get(part);
				}
			}
			return root;
		}

		function renderTreeNode(node, parent) {
			const entries = Array.from(node.children.values()).sort((a, b) =>
				a.label.localeCompare(b.label, "es")
			);
			for (const n of entries) {
				const li = document.createElement("li");
				const hasChildren = n.children.size > 0;
				li.innerHTML = `
					<button class="node ${state.folder === n.key ? "active" : ""}" data-path="${n.key}">
						${hasChildren ? `<span class="chev">▾</span>` : `<span class="leaf" aria-hidden="true"></span>`}
						<span class="label">${n.label}</span>
					</button>
				`;
				parent.appendChild(li);
				if (hasChildren) {
					const ul = document.createElement("ul");
					li.appendChild(ul);
					renderTreeNode(n, ul);
				}
			}
		}

		async function loadFolders() {
			treeEl.innerHTML = "";
			const rootBtn = document.createElement("button");
			rootBtn.className =
				"node " + (state.folder === "all" ? "active" : "");
			rootBtn.dataset.path = "all";
			rootBtn.innerHTML = `<span class="chev" aria-hidden="true">●</span><span class="label">Todas</span>`;
			treeEl.appendChild(rootBtn);

			try {
				const res = await apiFetch(FOLDERS_URL, { method: "GET" });
				if (!res.ok) throw new Error(await res.text());
				const { folders = [] } = await res.json();
				const t = buildTree(folders);
				const ul = document.createElement("ul");
				treeEl.appendChild(ul);
				renderTreeNode(t, ul);
			} catch (err) {
				console.error(err);
				const div = document.createElement("div");
				div.className = "sub";
				div.style.padding = ".4rem .6rem";
				div.textContent = "No se pudieron cargar carpetas";
				treeEl.appendChild(div);
			}
		}

		treeEl.addEventListener("click", (e) => {
			const b = e.target.closest(".node");
			if (!b) return;
			const path = b.dataset.path || "all";
			if (path === state.folder) return;
			state.folder = path;
			state.cursor = null;
			state.prevStack = [];
			treeEl
				.querySelectorAll(".node")
				.forEach((n) => n.classList.toggle("active", n === b));
			listAssets();
		});

		async function listAssets({ cursor = null } = {}) {
			grid.innerHTML = `<div class="media-card" style="padding:1rem">Cargando…</div>`;
			try {
				const params = new URLSearchParams();
				if (state.folder && state.folder !== "all")
					params.set("folder", state.folder);
				if (state.used !== "all") params.set("used", state.used);
				if (cursor) params.set("cursor", cursor);

				const res = await apiFetch(
					`${ASSETS_URL}?${params.toString()}`,
					{ method: "GET" }
				);
				if (!res.ok) {
					const j = await res.json().catch(() => ({}));
					grid.innerHTML = `<div class="media-card" style="padding:1rem;color:#a3122a">Error: ${j.error || res.status}</div>`;
					nextBtn.disabled = prevBtn.disabled = true;
					info.textContent = "";
					return;
				}
				const j = await res.json();
				const items = Array.isArray(j.items) ? j.items : [];
				if (state.used !== "all") {
					const want = state.used === "true";
					items = items.filter((it) => !!it.used === want);
				}
				state.lastItems = items;
				state.totalApprox = j.totalCountApprox ?? 0;

				renderGrid(items);

				nextBtn.disabled = !j.nextCursor;
				nextBtn.dataset.cursor = j.nextCursor || "";
				prevBtn.disabled = state.prevStack.length === 0;
				info.textContent = state.totalApprox
					? `~${state.totalApprox} elementos`
					: "";
			} catch (err) {
				console.error(err);
				grid.innerHTML = `<div class="media-card" style="padding:1rem;color:#a3122a">Error listando medios</div>`;
				nextBtn.disabled = prevBtn.disabled = true;
				info.textContent = "";
			}
		}

		function renderGrid(items) {
			if (items.length === 0) {
				grid.innerHTML = `<div class="media-card" style="padding:1rem">Sin resultados</div>`;
				return;
			}
			grid.innerHTML = "";
			for (const it of items) {
				const id = it.publicId || it.public_id || "";
				const url = it.secureUrl || it.secure_url || it.url || "";
				const w = it.width || 0;
				const h = it.height || 0;
				const fmt = it.format || "";
				const folder = it.folder || "";
				const rtype = it.resourceType || it.resource_type || "image";
				const used = !!it.used;

				const name = (id || "").split("/").pop();

				const card = document.createElement("div");
				card.className = "media-card";
				card.dataset.publicId = id;
				card.dataset.url = url;
				card.dataset.kind = rtype;
				card.innerHTML = `
					<div class="thumb">
						${
							rtype === "video"
								? `<video src="${url}" muted playsinline preload="metadata"></video>`
								: url
									? `<img src="${url}" alt="${name}">`
									: `<span>sin vista</span>`
						}
					</div>
					<div class="meta">
						<div class="name" title="${id}">${name || "(sin nombre)"}</div>
						<div class="sub">${w || "?"}×${h || "?"} · ${fmt || "?"}</div>
						<div class="row">
							${folder ? `<span class="tag">${folder}</span>` : ""}
							${rtype === "video" ? `<span class="tag">video</span>` : ""}
							<span class="badge ${used ? "is-used" : "is-unused"}">${used ? "En uso" : "Libre"}</span>
						</div>
						<div class="ops">
							<button class="kbtn" data-act="copy" data-url="${url}">Copiar URL</button>
							<button class="kbtn danger solid" data-act="del" data-id="${encodeURIComponent(id)}">Eliminar</button>
						</div>
					</div>
				`;

				card.addEventListener("click", (e) => {
					if (e.target.closest("button")) return;
					openPreview(it);
				});

				grid.appendChild(card);
			}
		}

		grid.addEventListener("click", async (e) => {
			const btn = e.target.closest("button");
			if (!btn) return;
			const act = btn.dataset.act;

			if (act === "copy") {
				const u = btn.dataset.url || "";
				if (!u) return;
				await navigator.clipboard.writeText(u);
				toastMsg("URL copiada");
				e.stopPropagation();
				return;
			}

			if (act === "del") {
				const id = btn.dataset.id
					? decodeURIComponent(btn.dataset.id)
					: "";
				if (!id) return;
				e.stopPropagation();
				if (!confirm(`¿Eliminar "${id}"?`)) return;
				const res = await apiFetch(
					`${DELETE_URL}?publicId=${encodeURIComponent(id)}`,
					{ method: "DELETE" }
				);
				if (res.ok) {
					toastMsg("Eliminado");
					listAssets();
				} else {
					const j = await res.json().catch(() => ({}));
					alert(j.error || "No se pudo eliminar");
				}
			}
		});

		nextBtn.addEventListener("click", () => {
			const cur = nextBtn.dataset.cursor;
			if (cur) {
				state.prevStack.push(cur);
				listAssets({ cursor: cur });
			}
		});
		prevBtn.addEventListener("click", () => {
			state.prevStack.pop();
			const prev = state.prevStack[state.prevStack.length - 1] || null;
			listAssets({ cursor: prev || undefined });
		});

		usedSeg?.addEventListener("click", (e) => {
			const btn = e.target.closest(".seg-btn");
			if (!btn) return;
			usedSeg
				.querySelectorAll(".seg-btn")
				.forEach((b) => b.classList.toggle("active", b === btn));
			state.used = btn.dataset.used || "all";
			state.cursor = null;
			state.prevStack = [];
			listAssets();
		});

		reloadBtn.addEventListener("click", () => listAssets());

		function escapeHtml(str) {
			return String(str || "").replace(
				/[&<>"']/g,
				(m) =>
					({
						"&": "&amp;",
						"<": "&lt;",
						">": "&gt;",
						'"': "&quot;",
						"'": "&#039;",
					})[m]
			);
		}

		function openPreview(it) {
			const id = it.publicId || it.public_id || "";
			const url = it.secureUrl || it.secure_url || it.url || "";
			const w = it.width || 0;
			const h = it.height || 0;
			const fmt = it.format || "";
			const folder = it.folder || "";
			const used = !!it.used;
			const rtype = it.resourceType || it.resource_type || "image";
			const created = it.createdAt || it.created_at || "";

			previewTitle.textContent =
				(id || "").split("/").pop() || "Vista previa";
			previewBody.innerHTML = "";
			if (rtype === "video") {
				const v = document.createElement("video");
				v.src = url;
				v.controls = true;
				v.playsInline = true;
				previewBody.appendChild(v);
			} else {
				const img = document.createElement("img");
				img.src = url;
				img.alt = previewTitle.textContent;
				previewBody.appendChild(img);
			}

			const usages = Array.isArray(it.usages) ? it.usages : [];
			const usageText = usages.length
				? usages
						.map(
							(u) =>
								`${escapeHtml(u.kind || "")}${u.titulo ? ` — ${escapeHtml(u.titulo)}` : ""}`
						)
						.join("<br>")
				: "—";

			previewMeta.innerHTML = [
				["Archivo", id || "—"],
				["Carpeta", folder || "—"],
				["Tamaño", `${w || "?"} × ${h || "?"}`],
				["Formato", fmt || "—"],
				[
					"Creado",
					created ? new Date(created).toLocaleString("es-AR") : "—",
				],
				["Estado", used ? "En uso" : "Libre"],
				["Usos", usageText],
			]
				.map(
					([k, v]) =>
						`<div class="row"><b>${k}</b><div>${v}</div></div>`
				)
				.join("");

			previewCopy.dataset.url = url;
			previewOpen.dataset.url = url;

			previewModal.showModal();
		}

		previewCopy.addEventListener("click", async () => {
			const u = previewCopy.dataset.url || "";
			if (!u) return;
			await navigator.clipboard.writeText(u);
			toastMsg("URL copiada");
		});
		previewOpen.addEventListener("click", () => {
			const u = previewOpen.dataset.url || "";
			if (!u) return;
			window.open(u, "_blank", "noopener,noreferrer");
		});
		previewClose.addEventListener("click", () => previewModal.close());
		previewModal.addEventListener("click", (e) => {
			if (e.target === previewModal) previewModal.close();
		});

		await loadFolders();
		await listAssets();
	</script>
</DashboardLayout>
