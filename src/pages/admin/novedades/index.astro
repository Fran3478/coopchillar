---
export const prerender = false;
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="Novedades">
	<section class="page">
		<header class="page-head">
			<div class="titles">
				<h1>Novedades</h1>
				<p class="subtitle">Aparecen en el slider de la portada.</p>
			</div>
			<div class="actions">
				<input id="q" class="inp" placeholder="Buscar…" />
				<a class="btn primary" href="/admin/novedades/nueva"
					>Nueva novedad</a
				>
			</div>
		</header>

		<article class="card">
			<table class="tbl">
				<thead>
					<tr>
						<th>Título</th>
						<th class="hidem">Enlace</th>
						<th class="hidem">Estado</th>
						<th style="width:1%"></th>
					</tr>
				</thead>
				<tbody id="rows">
					<tr><td colspan="4" class="empty">Cargando…</td></tr>
				</tbody>
			</table>
		</article>

		<div class="pager">
			<button id="prev" class="btn ghost">← Anterior</button>
			<span id="info" class="muted"></span>
			<button id="next" class="btn ghost">Siguiente →</button>
		</div>
	</section>

	<style>
		.page {
			max-width: 1100px;
			margin: 0 auto;
			padding: 1rem;
		}
		.page-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			background: color-mix(in oklab, #fff 92%, var(--bg));
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 0.9rem 1rem;
			position: static;
			margin-bottom: 12px;
		}
		.titles h1 {
			margin: 0.05rem 0;
			color: var(--brand);
			font-size: 1.25rem;
		}
		.subtitle {
			margin: 0;
			color: var(--muted);
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.inp {
			padding: 0.6rem 0.8rem;
			border: 1px solid var(--border);
			border-radius: 0.55rem;
			min-width: 220px;
		}
		.btn {
			appearance: none;
			border: 1px solid var(--border);
			background: #fff;
			color: #111;
			padding: 0.5rem 0.8rem;
			border-radius: 0.55rem;
			font-weight: 600;
			cursor: pointer;
		}
		.btn.primary {
			background: var(--accent);
			color: #fff;
			border-color: color-mix(in oklab, var(--accent), black 10%);
		}
		.btn.ghost:hover {
			background: #eef2f7;
		}

		.card {
			background: #fff;
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 0;
			overflow: hidden;
		}
		.muted {
			color: var(--muted);
		}
		.pager {
			display: flex;
			gap: 0.5rem;
			align-items: center;
			justify-content: center;
			padding: 0.9rem 0;
		}

		@media (max-width: 820px) {
			.inp {
				min-width: 130px;
			}
			.hidem {
				display: none;
			}
		}

		:global(table.tbl) {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			background: #fff;
		}
		:global(.tbl thead th) {
			text-align: left;
			padding: 12px 16px;
			font-weight: 700;
			color: var(--brand, #0b2a66);
			background: #f8fafc;
			border-bottom: 1px solid var(--border, #e5e7eb);
		}
		:global(.tbl tbody td) {
			padding: 14px 16px;
			vertical-align: middle;
			border-bottom: 1px solid #eef1f5;
			word-wrap: break-word;
		}
		:global(.tbl tbody tr:last-child td) {
			border-bottom: 0;
		}
		:global(.tbl tbody tr:hover td) {
			background: #fafcff;
		}

		:global(.td.title .row-title) {
			font-weight: 700;
			color: #0f172a;
			text-decoration: none;
		}
		:global(.td.title .row-title:hover) {
			text-decoration: underline;
		}
		:global(.td.title .row-sub) {
			color: #6b7280;
			font-size: 0.9rem;
			margin-top: 2px;
		}

		:global(.td.actions) {
			white-space: nowrap;
			width: 1%;
			padding-right: 20px;
		}
		:global(.row-actions) {
			display: inline-flex;
			gap: 8px;
			align-items: center;
			flex-wrap: wrap;
		}
		:global(.kbtn) {
			appearance: none;
			border: 1px solid var(--border, #e5e7eb);
			background: #fff;
			color: #111827;
			padding: 0.35rem 0.6rem;
			border-radius: 0.5rem;
			font-weight: 600;
			cursor: pointer;
			text-decoration: none;
		}
		:global(.kbtn:hover) {
			filter: brightness(0.98);
		}
		:global(.kbtn.ghost) {
			background: #f8fafc;
		}

		:global(.badge) {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 999px;
			font-weight: 700;
			font-size: 0.82rem;
		}
		:global(.badge.is-published) {
			background: #eafaf0;
			color: #166534;
			border: 1px solid #bbf7d0;
		}
		:global(.badge.is-draft) {
			background: #fff7ed;
			color: #9a3412;
			border: 1px solid #fed7aa;
		}
		:global(.badge.is-archived) {
			background: #fee2e2;
			color: #991b1b;
			border: 1px solid #fecaca;
		}

		:global(.empty) {
			text-align: center;
			color: var(--muted);
			padding: 2rem 0;
		}
	</style>

	<script type="module">
		function getCookie(name) {
			const pairs = document.cookie ? document.cookie.split("; ") : [];
			for (const p of pairs) {
				const i = p.indexOf("="),
					k = i > -1 ? p.slice(0, i) : p;
				if (k === name)
					return decodeURIComponent(i > -1 ? p.slice(i + 1) : "");
			}
			return null;
		}
		async function api(path, init = {}) {
			const h = new Headers(init.headers || {});
			const token = getCookie("access_token");
			if (!h.has("Content-Type"))
				h.set("Content-Type", "application/json");
			if (token && !h.has("Authorization"))
				h.set("Authorization", "Bearer " + token);
			const res = await fetch(path, {
				...init,
				headers: h,
				credentials: "include",
			});
			if (!res.ok) throw res;
			return res.json();
		}
		const estadoView = (s) => {
			const M = {
				published: ["Publicada", "is-published"],
				draft: ["Borrador", "is-draft"],
				archived: ["Archivada", "is-archived"],
			};
			const [label, cls] = M[s] || M.draft;
			return `<span class="badge ${cls}">${label}</span>`;
		};

		const rows = document.getElementById("rows");
		const qEl = document.getElementById("q");
		const prev = document.getElementById("prev");
		const next = document.getElementById("next");
		const info = document.getElementById("info");

		let page = 1,
			pageSize = 10,
			total = 0,
			items = [];

		async function load() {
			rows.innerHTML = `<tr><td colspan="4" class="empty">Cargando…</td></tr>`;
			try {
				const data = await api(
					`/v1/posts?tipo=novedad&page=${page}&pageSize=${pageSize}${qEl.value ? `&q=${encodeURIComponent(qEl.value)}` : ""}`
				);
				items = data.items || [];
				total = data.total || 0;
				render();
			} catch (e) {
				rows.innerHTML = `<tr><td colspan="4" class="empty">Error cargando.</td></tr>`;
			}
		}

		function render() {
			if (!items.length) {
				rows.innerHTML = `<tr><td colspan="4" class="empty">No hay novedades aún.</td></tr>`;
				info.textContent = "";
				return;
			}

			rows.innerHTML = items
				.map(
					(p) => `
      <tr data-id="${p.id}">
        <td class="td title">
          <a class="row-title" href="/admin/novedades/editar?id=${p.id}" target="_blank">${p.titulo ?? "—"}</a>
          <div class="row-sub">${p.slug ?? ""}</div>
        </td>
        <td class="td hidem">
          ${p.linkUrl ? `<a href="${p.linkUrl}" target="_blank" rel="noopener">Abrir</a>` : "—"}
        </td>
        <td class="td hidem">${estadoView(p.estado)}</td>
        <td class="td actions">
          <div class="row-actions">
            <a class="kbtn" href="/admin/novedades/editar?id=${p.id}" target="_blank">Editar</a>
            ${
				p.estado === "published"
					? '<button class="kbtn ghost act-unpub">Despublicar</button>'
					: '<button class="kbtn ghost act-pub">Publicar</button>'
			}
          </div>
        </td>
      </tr>
    `
				)
				.join("");

			const first = (page - 1) * pageSize + 1;
			const last = Math.min(page * pageSize, total);
			info.textContent = `${first}-${last} de ${total}`;

			rows.querySelectorAll(".act-pub").forEach((btn) => {
				btn.addEventListener("click", async (e) => {
					const el = e.currentTarget;
					if (!(el instanceof Element)) return;
					const tr = el.closest("tr");
					const id = tr?.dataset.id;
					if (!id) return;
					await api(`/v1/posts/${id}/publish`, { method: "POST" });
					load();
				});
			});

			rows.querySelectorAll(".act-unpub").forEach((btn) => {
				btn.addEventListener("click", async (e) => {
					const el = e.currentTarget;
					if (!(el instanceof Element)) return;
					const tr = el.closest("tr");
					const id = tr?.dataset.id;
					if (!id) return;
					await api(`/v1/posts/${id}/unpublish`, { method: "POST" });
					load();
				});
			});
		}

		qEl.addEventListener("input", () => {
			page = 1;
			load();
		});
		prev.addEventListener("click", () => {
			if (page > 1) {
				page--;
				load();
			}
		});
		next.addEventListener("click", () => {
			if (page * pageSize < total) {
				page++;
				load();
			}
		});

		load();
	</script>
</DashboardLayout>
