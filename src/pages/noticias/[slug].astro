---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";

const TENANT_ID = Number(import.meta.env.PUBLIC_TENANT_ID) || 1;
const origin = Astro.url.origin;
const apiBase = `${origin}/v1/public/tenants/${TENANT_ID}`;

const slug = Astro.params.slug as string;

function fmtDate(iso?: string) {
	if (!iso) return "";
	try {
		return new Date(iso).toLocaleDateString("es-AR", {
			day: "2-digit",
			month: "long",
			year: "numeric",
		});
	} catch {
		return "";
	}
}

function renderBlocks(blocksJson: any): string {
	const blocks = blocksJson?.blocks || [];
	const html: string[] = [];

	for (const b of blocks) {
		const t = b.type;
		const d = b.data || {};

		if (t === "paragraph") {
			html.push(`<p>${d.text ?? ""}</p>`);
		} else if (t === "header") {
			const lvl = Math.min(Math.max(Number(d.level || 2), 1), 6);
			html.push(`<h${lvl}>${d.text ?? ""}</h${lvl}>`);
		} else if (t === "list") {
			const tag = d.style === "ordered" ? "ol" : "ul";
			const items = Array.isArray(d.items)
				? d.items.map((it: string) => `<li>${it}</li>`).join("")
				: "";
			html.push(`<${tag}>${items}</${tag}>`);
		} else if (t === "image") {
			const url = d.file?.url || d.url;
			const cap = d.caption
				? `<figcaption>${d.caption}</figcaption>`
				: "";
			if (url) {
				html.push(
					`<figure><img src="${url}" alt="${d.caption || ""}" />${cap}</figure>`,
				);
			}
		}
	}

	return html.join("\n");
}

let post: any = null;
let notFound = false;

try {
	const res = await fetch(`${apiBase}/posts/${encodeURIComponent(slug)}`);
	if (res.ok) {
		post = await res.json();
		if (post?.tipo !== "noticia") notFound = true;
	} else {
		notFound = true;
	}
} catch {
	notFound = true;
}

const html = post ? renderBlocks(post.blocksJson) : "";
---

<Layout title={post?.titulo ? `${post.titulo} · Noticias` : "Noticia"}>
	<div id="main-content" class:list={{ "is-notfound": notFound }}>
		<main class="wrap">
			{
				notFound ? (
					<section class="notfound" aria-labelledby="nf-title">
						<div class="notfound-card">
							<h1 id="nf-title">No encontrada</h1>
							<p class="nf-text">
								La noticia solicitada no existe o fue movida.
							</p>
							<div class="nf-actions">
								<a class="btn" href="/noticias">
									Volver a noticias
								</a>
								<a class="btn btn--ghost" href="/">
									Ir al inicio
								</a>
							</div>
						</div>
					</section>
				) : (
					<>
						<header class="head">
							<h1 class="title">{post.titulo}</h1>
							<div class="meta">
								<time datetime={post.publicadoEn || ""}>
									{fmtDate(post.publicadoEn)}
								</time>
							</div>
							{post.excerpt && <p class="lead">{post.excerpt}</p>}
						</header>

						{post.portadaUrl ? (
							<figure class="hero">
								<img
									src={post.portadaUrl}
									alt={post.titulo || "Portada"}
								/>
							</figure>
						) : null}

						<article class="article">
							<section class="content" set:html={html} />
						</article>

						<p class="back">
							<a href="/noticias" class="btn btn--ghost">
								← Volver a noticias
							</a>
						</p>
					</>
				)
			}
		</main>
	</div>

	<style>
		:root {
			/* branding (igual que Institucional) */
			--brand: #06752e;
			--accent: #ffcd34;

			--text: #111827;
			--muted: #4b5563;
			--bg: #f6f7fb;
			--card: #ffffff;
			--border: rgba(17, 24, 39, 0.08);

			--brand-ghost: color-mix(in oklab, var(--brand), white 92%);
			--accent-ghost: color-mix(in oklab, var(--accent), white 82%);

			--article-max: 1000px;
		}

		#main-content {
			padding-top: clamp(96px, 12vw, 160px);
			margin: 0;
			transition: padding-top 0.3s ease;
			background: var(--bg);
			overflow-x: hidden;
			min-height: calc(100vh - 1px);
		}

		.wrap {
			max-width: 1100px;
			margin: 0 auto;
			padding: clamp(1rem, 4vw, 2rem);
		}

		/* =========
		   NOT FOUND
		   ========= */
		#main-content.is-notfound .wrap {
			min-height: calc(100vh - clamp(96px, 12vw, 160px));
			display: grid;
			place-items: center;
			padding-top: 0;
			padding-bottom: 0;
		}

		.notfound {
			width: 100%;
			display: grid;
			place-items: center;
			padding: 1rem 0;
		}

		.notfound-card {
			width: min(720px, 100%);
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 18px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			padding: clamp(1.2rem, 4vw, 2rem);
			text-align: center;
		}

		.notfound h1 {
			margin: 0 0 0.5rem;
			color: var(--brand);
			font-size: clamp(1.7rem, 3.5vw, 2.3rem);
			letter-spacing: -0.02em;
		}

		.nf-text {
			margin: 0 auto 1.2rem;
			max-width: 52ch;
			color: var(--muted);
			font-size: 1.05rem;
			line-height: 1.6;
		}

		.nf-actions {
			display: flex;
			gap: 0.8rem;
			justify-content: center;
			flex-wrap: wrap;
		}

		/* =========
		   ARTICULO
		   ========= */
		.head {
			margin: 0 0 1.2rem;
			padding-top: 0.25rem;
			text-align: initial;
		}

		.title {
			margin: 0.5rem 0 0.65rem;
			font-weight: 900;
			color: var(--text);
			letter-spacing: -0.02em;
			font-size: clamp(1.8rem, 3.2vw + 1rem, 2.6rem);
			line-height: 1.15;
			text-align: center;
		}

		.meta {
			color: var(--muted);
			font-size: 0.95rem;
			margin: 0.1rem auto 0.75rem;
			max-width: var(--article-max);
			text-align: left;
		}

		.lead {
			margin: 0 auto 0.35rem;
			max-width: var(--article-max);
			color: #374151;
			font-size: clamp(1.05rem, 0.4vw + 1rem, 1.2rem);
			line-height: 1.6;
			text-align: left;
		}

		.hero {
			margin: 0 auto 14px;
			max-width: var(--article-max);
		}

		.hero img {
			display: block;
			width: 100%;
			height: auto;
			object-fit: cover;
			border-radius: 18px;
			aspect-ratio: 16 / 9;
			border: 1px solid var(--border);
		}

		.article {
			display: block;
		}

		.content {
			max-width: var(--article-max);
			margin: clamp(1.2rem, 4vw, 2.2rem) auto;
			padding: 0 6px;
			font-size: 1.06rem;
			line-height: 1.8;
			color: #1f2937;
			overflow-wrap: anywhere;
		}

		.content :where(h2, h3, h4) {
			color: color-mix(in oklab, var(--brand), black 10%);
			margin: 1.25em 0 0.5em;
			line-height: 1.25;
		}

		.content :where(h2) {
			border-left: 5px solid var(--accent);
			padding-left: 0.95rem;
		}

		.content p {
			margin: 0.9em 0;
		}

		.content ul,
		.content ol {
			padding-left: 1.25rem;
			margin: 0.8rem 0;
		}

		.content :where(img, video, iframe, embed, object) {
			max-width: 100%;
			height: auto;
			display: block;
		}

		.content figure {
			margin: 1.1rem 0;
			max-width: 100%;
		}

		.content figure img {
			width: 100%;
			max-width: 100%;
			border-radius: 16px;
			border: 1px solid var(--border);
			margin: 0 auto;
		}

		.content figcaption {
			color: var(--muted);
			font-size: 0.92rem;
			text-align: center;
			margin-top: 0.35rem;
		}

		/* Botones (mismo estilo que Institucional) */
		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			padding: 0.75rem 1rem;
			border-radius: 999px;
			font-weight: 900;
			text-decoration: none;
			background: var(--brand);
			color: #fff;
			border: 2px solid var(--brand);
			transition:
				transform 0.15s ease,
				opacity 0.15s ease,
				box-shadow 0.15s ease;
		}

		.btn:hover {
			transform: translateY(-1px);
			opacity: 0.96;
			box-shadow: 0 10px 22px rgba(6, 117, 46, 0.18);
		}

		.btn--ghost {
			background: transparent;
			color: var(--brand);
		}

		.btn--ghost:hover {
			background: color-mix(in oklab, var(--brand), white 92%);
			box-shadow: none;
		}

		.back {
			margin: 0.75rem 0 0;
			text-align: center;
		}

		/* Figure “full bleed” suave en desktop, sin romper el centrado */
		@media (min-width: 900px) {
			.content figure {
				margin-left: -24px;
				margin-right: -24px;
			}
		}
	</style>
</Layout>
