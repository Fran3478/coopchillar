---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";

const TENANT_ID = Number(import.meta.env.PUBLIC_TENANT_ID) || 1;

const page = Number(Astro.url.searchParams.get("page") || "1");
const pageSize = 12;

const origin = Astro.url.origin;
const apiBase = `${origin}/v1/public/tenants/${TENANT_ID}`;

function fmtDate(iso?: string) {
	if (!iso) return "";
	try {
		return new Date(iso).toLocaleDateString("es-AR", {
			day: "2-digit",
			month: "short",
			year: "numeric",
		});
	} catch {
		return "";
	}
}

let items: any[] = [];
let total = 0;

try {
	const qs = new URLSearchParams({
		tipo: "noticia",
		estado: "published",
		page: String(page),
		pageSize: String(pageSize),
	});
	const res = await fetch(`${apiBase}/posts?${qs.toString()}`);
	if (res.ok) {
		const j = await res.json();
		items = j.items || [];
		total = j.total || 0;
	}
} catch {}

const first = (page - 1) * pageSize + 1;
const last = Math.min(page * pageSize, total);
const hasPrev = page > 1;
const hasNext = page * pageSize < total;
---

<Layout title="Noticias">
	<div id="main-content">
		<main class="content">
			<header class="head">
				<h1>Noticias</h1>
				<p class="sub">Últimas publicaciones del sitio.</p>
			</header>

			{
				items.length === 0 ? (
					<section class="empty" aria-labelledby="empty-title">
						<div class="empty-card">
							<h2 id="empty-title">
								Todavía no hay noticias publicadas
							</h2>
							<p class="empty-text">
								Cuando se carguen novedades, van a aparecer acá.
								Mientras tanto, podés volver al inicio o
								comunicarte con la cooperativa.
							</p>
							<div class="empty-actions">
								<a class="btn" href="/">
									Ir al inicio
								</a>
								<a class="btn btn--ghost" href="/contacto">
									Contacto
								</a>
							</div>
						</div>
					</section>
				) : (
					<>
						<section class="grid" aria-label="Listado de noticias">
							{items.map((p) => (
								<article class="card" data-id={p.id}>
									<a
										href={`/noticias/${p.slug}`}
										class="media"
										aria-label={p.titulo}
									>
										{p.portadaUrl ? (
											<img
												src={p.portadaUrl}
												alt={p.titulo || "Portada"}
												loading="lazy"
											/>
										) : (
											<img
												src="/images/logo.webp"
												alt={p.titulo || "Portada"}
												loading="lazy"
											/>
										)}
									</a>

									<div class="body">
										<h2 class="title">
											<a href={`/noticias/${p.slug}`}>
												{p.titulo ?? "Sin título"}
											</a>
										</h2>

										<div class="meta">
											<time
												datetime={p.publicadoEn || ""}
											>
												{fmtDate(p.publicadoEn)}
											</time>
										</div>

										{p.excerpt ? (
											<p class="excerpt">{p.excerpt}</p>
										) : null}

										<div class="actions">
											<a
												class="btn"
												href={`/noticias/${p.slug}`}
											>
												Leer nota
											</a>
										</div>
									</div>
								</article>
							))}
						</section>

						{total > pageSize && (
							<nav
								class="pager"
								aria-label="Paginación de noticias"
							>
								<a
									class={`kbtn ${hasPrev ? "" : "disabled"}`}
									href={
										hasPrev
											? `/noticias?page=${page - 1}`
											: "#"
									}
								>
									← Anteriores
								</a>
								<span class="muted">
									{first}-{last} de {total}
								</span>
								<a
									class={`kbtn ${hasNext ? "" : "disabled"}`}
									href={
										hasNext
											? `/noticias?page=${page + 1}`
											: "#"
									}
								>
									Siguientes →
								</a>
							</nav>
						)}
					</>
				)
			}
		</main>
	</div>

	<style>
		:root {
			--brand: #06752e;
			--accent: #ffcd34;

			--text: #111827;
			--muted: #4b5563;
			--bg: #f6f7fb;
			--card: #ffffff;
			--border: rgba(17, 24, 39, 0.08);

			--brand-ghost: color-mix(in oklab, var(--brand), white 92%);
			--accent-ghost: color-mix(in oklab, var(--accent), white 82%);
		}

		#main-content {
			padding-top: clamp(96px, 12vw, 160px);
			margin: 0;
			transition: padding-top 0.3s ease;
			background: var(--bg);
			min-height: 100vh;
		}

		.content {
			max-width: 1100px;
			margin: 0 auto;
			padding: clamp(1rem, 4vw, 2rem);
			color: var(--text);
		}

		.head {
			text-align: center;
			margin: 0 0 1.25rem;
		}

		.head h1 {
			margin: 0 0 0.35rem;
			color: var(--brand);
			font-size: clamp(1.9rem, 4vw, 2.6rem);
			letter-spacing: -0.02em;
		}

		.head .sub {
			margin: 0;
			color: var(--muted);
			font-size: 1.05rem;
		}

		.empty {
			margin: 0;
			padding: 0.5rem 0 0;
		}

		.empty-card {
			max-width: 760px;
			margin: 0 auto;
			background: linear-gradient(
				135deg,
				color-mix(in oklab, var(--brand), white 92%),
				color-mix(in oklab, var(--accent), white 90%)
			);
			border: 1px solid color-mix(in oklab, var(--brand), white 84%);
			border-radius: 18px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			padding: clamp(1rem, 3.5vw, 1.6rem);
			text-align: center;
		}

		.empty-card h2 {
			margin: 0 0 0.5rem;
			color: color-mix(in oklab, var(--brand), black 10%);
			font-size: clamp(1.2rem, 2.5vw, 1.6rem);
		}

		.empty-text {
			margin: 0 auto 1rem;
			max-width: 62ch;
			color: #374151;
			line-height: 1.55;
		}

		.empty-actions {
			display: flex;
			gap: 0.7rem;
			justify-content: center;
			flex-wrap: wrap;
		}

		.grid {
			display: grid;
			gap: 16px;
			grid-template-columns: repeat(3, minmax(0, 1fr));
		}

		@media (max-width: 1024px) {
			.grid {
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}
		}

		@media (max-width: 640px) {
			.grid {
				grid-template-columns: 1fr;
			}
			.empty-actions .btn {
				width: 100%;
			}
		}

		.card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 18px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			height: 100%;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
			transition:
				transform 0.15s ease,
				box-shadow 0.15s ease;
		}

		.card:hover {
			transform: translateY(-2px);
			box-shadow: 0 12px 26px rgba(6, 117, 46, 0.1);
		}

		.media {
			display: block;
			aspect-ratio: 16 / 9;
			background: #eef1f5;
		}

		.media img {
			width: 100%;
			height: 250px;
			object-fit: cover;
			display: block;
		}

		.body {
			padding: 12px 14px 14px;
			display: flex;
			flex-direction: column;
			flex: 1;
			min-height: 0;
		}

		.title {
			margin: 2px 0 6px;
			font-size: 1.05rem;
			line-height: 1.25;
		}

		.title a {
			color: #0f172a;
			text-decoration: none;
		}

		.title a:hover {
			text-decoration: underline;
		}

		.meta {
			color: var(--muted);
			font-size: 0.9rem;
			margin-bottom: 0.45rem;
		}

		.excerpt {
			margin: 0.25rem 0 0.75rem;
			color: #374151;
			line-height: 1.55;
		}

		.actions {
			margin-top: auto;
			padding-top: 0.25rem;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			padding: 0.7rem 1rem;
			border-radius: 999px;
			font-weight: 900;
			text-decoration: none;
			background: var(--brand);
			color: #fff;
			border: 2px solid var(--brand);
			transition:
				transform 0.15s ease,
				opacity 0.15s ease,
				box-shadow 0.15s ease;
		}

		.btn:hover {
			transform: translateY(-1px);
			opacity: 0.96;
			box-shadow: 0 10px 22px rgba(6, 117, 46, 0.18);
		}

		.btn--ghost {
			background: transparent;
			color: var(--brand);
		}

		.btn--ghost:hover {
			background: color-mix(in oklab, var(--brand), white 92%);
			box-shadow: none;
		}

		.pager {
			display: flex;
			gap: 0.65rem;
			align-items: center;
			justify-content: center;
			padding: 1.1rem 0 0.25rem;
			flex-wrap: wrap;
		}

		.kbtn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			text-decoration: none;
			font-weight: 800;
			background: #fff;
			border: 1px solid var(--border);
			color: #111827;
			padding: 0.55rem 0.85rem;
			border-radius: 999px;
		}

		.kbtn:hover {
			border-color: color-mix(in oklab, var(--brand), white 70%);
			box-shadow: 0 10px 22px rgba(6, 117, 46, 0.08);
		}

		.kbtn.disabled {
			opacity: 0.5;
			pointer-events: none;
		}

		.muted {
			color: var(--muted);
			font-weight: 600;
		}
	</style>
</Layout>
