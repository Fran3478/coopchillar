---
interface Item {
	slug: string;
	title: string;
	imageUrl?: string;
	date?: string;
	category?: string;
}

const { noticias = [] } = Astro.props as { noticias: Item[] };

function fmt(d?: string) {
	if (!d) return "";
	const dt = new Date(d);
	return new Intl.DateTimeFormat("es-AR", {
		day: "2-digit",
		month: "short",
	}).format(dt);
}

const imgOr = (fallback: string) => (url?: string) => url || fallback;
const fallbackBlog = "/images/logo.webp";
const safeBlogImg = imgOr(fallbackBlog);
---

<div class="blog-sidebar">
	<h3 class="blog-title">Noticias</h3>

	<div class="blog-carousel">
		{
			noticias.length === 0 ? (
				<div class="empty-list">
					<span class="empty-icon" aria-hidden="true">
						ðŸ“°
					</span>
					<p class="empty-title">TodavÃ­a no hay noticias</p>
					<p class="empty-sub">
						PublicÃ¡ tu primera noticia para mostrarla en este
						listado.
					</p>
				</div>
			) : (
				<>
					<div class="blog-entries" id="blog-entries">
						{noticias.map((p) => (
							<div class="blog-entry">
								<img
									src={safeBlogImg(p.imageUrl)}
									alt={p.title}
								/>
								<div>
									<p class="blog-entry-title">
										<a
											href={`/noticias/${p.slug}`}
											style="color:inherit;text-decoration:none"
										>
											{p.title}
										</a>
									</p>
									{p.category && (
										<p class="blog-entry-category">
											{p.category}
										</p>
									)}
									<p class="blog-entry-date">{fmt(p.date)}</p>
								</div>
							</div>
						))}
					</div>

					{noticias.length > 5 && (
						<div class="blog-arrows" id="blog-arrows">
							<button class="blog-arrow" id="blog-prev">
								&#x25B2;
							</button>
							<button class="blog-arrow" id="blog-next">
								&#x25BC;
							</button>
						</div>
					)}
				</>
			)
		}
	</div>

	<a href="/noticias" class="ver-todo-btn">VER TODO &rarr;</a>
</div>

<style>
	.blog-sidebar {
		flex: 1 1 33%;
		max-width: 33%;
	}

	.blog-title {
		color: #06752e;
		font-weight: bold;
		font-size: 1.2rem;
		margin-bottom: 1rem;
	}

	.blog-carousel {
		position: relative;
		flex: 1;
		overflow: hidden;
		max-height: 490px;
	}

	.blog-entries {
		display: flex;
		flex-direction: column;
		transition: transform 0.5s ease;
	}

	.blog-entry {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
		align-items: center;
		height: 80px;
	}

	.blog-entry img {
		width: 80px;
		height: 60px;
		object-fit: cover;
		border-radius: 12px;
	}

	.blog-entry-title {
		font-weight: bold;
		font-size: 0.95rem;
		margin: 0;
		color: #333;
	}

	.blog-entry-category {
		font-size: 0.8rem;
		color: #888;
		margin: 0.2rem 0;
	}

	.blog-entry-date {
		font-size: 0.75rem;
		color: #666;
		margin: 0;
	}

	.blog-arrows {
		position: absolute;
		top: 0.5rem;
		right: 0;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.blog-arrow {
		background-color: #06752e;
		color: white;
		border: none;
		width: 32px;
		height: 32px;
		border-radius: 50%;
		cursor: pointer;
		opacity: 0.8;
		transition: background 0.3s ease;
	}

	.blog-arrow:hover {
		background-color: #1bae70;
	}

	.ver-todo-btn {
		display: inline-block;
		margin-top: 0.75rem;
		background-color: #06752e;
		color: white;
		text-decoration: none;
		padding: 0.6rem 1.2rem;
		border-radius: 999px;
		font-weight: bold;
		font-size: 0.9rem;
		transition: background 0.3s ease;
	}

	.ver-todo-btn:hover {
		background-color: #1bae70;
	}

	.empty-list {
		box-sizing: border-box;
		width: 100%;
		min-height: 240px;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 0.25rem;
		background: #f7f8fb;
		border: 1px dashed #d8dbe5;
		border-radius: 15px;
		text-align: center;
		color: #556;
		padding: 1.25rem;
	}

	.empty-icon {
		font-size: 28px;
		opacity: 0.7;
	}

	.empty-title {
		margin: 0.25rem 0 0;
		font-weight: 700;
		color: #223;
	}

	.empty-sub {
		margin: 0;
		font-size: 0.9rem;
		color: #667;
	}

	@media (max-width: 1070px) {
		.blog-sidebar {
			max-width: 100%;
		}
	}
</style>

<script>
	const blogEntries = document.getElementById("blog-entries");
	const blogPrev = document.getElementById("blog-prev");
	const blogNext = document.getElementById("blog-next");
	const blogArrows = document.getElementById("blog-arrows");

	const entryHeight = 90;
	let blogIndex = 0;
	const totalEntries = blogEntries ? blogEntries.children.length : 0;
	const maxVisible = 5;
	let autoScrollInterval = null;

	function updateBlog() {
		if (!blogEntries) return;
		blogEntries.style.transform = `translateY(${-blogIndex * entryHeight}px)`;
	}

	function startAuto() {
		if (totalEntries > maxVisible && autoScrollInterval === null) {
			autoScrollInterval = window.setInterval(() => {
				blogIndex = (blogIndex + 1) % (totalEntries - maxVisible + 1);
				updateBlog();
			}, 5000);
		}
	}

	function stopAuto() {
		if (autoScrollInterval !== null) {
			window.clearInterval(autoScrollInterval);
			autoScrollInterval = null;
		}
	}

	blogNext?.addEventListener("click", () => {
		if (blogIndex < totalEntries - maxVisible) {
			blogIndex++;
			updateBlog();
			stopAuto();
			startAuto();
		}
	});

	blogPrev?.addEventListener("click", () => {
		if (blogIndex > 0) {
			blogIndex--;
			updateBlog();
			stopAuto();
			startAuto();
		}
	});

	if (blogArrows) {
		blogArrows.style.display = totalEntries > maxVisible ? "flex" : "none";
	}

	updateBlog();
	startAuto();
</script>
