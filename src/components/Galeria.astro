---
export interface ImageItem {
	src: string;
	alt?: string;
	description?: string;
}

interface Props {
	images: ImageItem[];
	layout?: "masonry" | "collage";

	maxVisible?: number;
	columns?: {
		mobile?: number;
		tablet?: number;
		desktop?: number;
		wide?: number;
	};
	gap?: number;
	maxWidth?: string;

	collageMaxWidth?: string;

	thumbWidth?: number;
	modalTopPadding?: number;
}

const {
	images,
	layout = "masonry",
	maxVisible = 6,
	columns = { mobile: 1, tablet: 2, desktop: 3, wide: 4 },
	gap = 12,
	maxWidth = "1200px",
	collageMaxWidth = "1200px",
	thumbWidth = 140,
	modalTopPadding = 80,
} = Astro.props;

const visible =
	layout === "masonry" ? images.slice(0, maxVisible) : images.slice(0, 6);
---

<section class={`gal ${layout}`}>
	{
		layout === "masonry" ? (
			<div
				class="grid"
				style={`--gap:${gap}px; --maxw:${maxWidth}; --cols-m:${columns.mobile ?? 1}; --cols-t:${columns.tablet ?? 2}; --cols-d:${columns.desktop ?? 3}; --cols-w:${columns.wide ?? 4};`}
			>
				{visible.map((img, i) => (
					<figure class="item">
						<img
							src={img.src}
							alt={img.alt ?? ""}
							loading="lazy"
							decoding="async"
							data-idx={i}
							data-src={img.src}
							data-alt={img.alt ?? ""}
							data-desc={img.description ?? ""}
						/>
					</figure>
				))}
			</div>
		) : (
			<div class="collage" style={`--maxw:${collageMaxWidth};`}>
				{visible.map((img, i) => (
					<figure class={`slot s${i}`}>
						<img
							src={img.src}
							alt={img.alt ?? ""}
							loading="lazy"
							decoding="async"
							data-idx={i}
							data-src={img.src}
							data-alt={img.alt ?? ""}
							data-desc={img.description ?? ""}
						/>
					</figure>
				))}
			</div>
		)
	}

	<div
		class="lb hidden"
		aria-hidden="true"
		role="dialog"
		aria-modal="true"
		style={`--lb-top:${modalTopPadding}px; --thumb-w:${thumbWidth}px;`}
	>
		<div class="backdrop" data-action="close"></div>

		<div class="dialog">
			<button
				class="close"
				type="button"
				aria-label="Cerrar"
				data-action="close">×</button
			>

			<div class="card">
				<div class="stage">
					<button
						class="nav prev desktop-only"
						type="button"
						aria-label="Anterior"
						data-action="prev">‹</button
					>
					<div class="media">
						<img class="big" alt="" />
					</div>
					<button
						class="nav next desktop-only"
						type="button"
						aria-label="Siguiente"
						data-action="next">›</button
					>
				</div>

				<div class="meta">
					<div class="title"></div>
					<div class="desc"></div>
				</div>
			</div>

			<div class="thumbs">
				<button
					class="th-btn desktop-only"
					data-action="thumb-prev"
					aria-label="Miniaturas anteriores">‹</button
				>
				<div class="th-strip">
					{
						images.map((img, i) => (
							<button
								class="th"
								data-idx={i}
								title={img.alt ?? ""}
							>
								<img
									src={img.src}
									alt={img.alt ?? ""}
									loading="lazy"
								/>
							</button>
						))
					}
				</div>
				<button
					class="th-btn desktop-only"
					data-action="thumb-next"
					aria-label="Miniaturas siguientes">›</button
				>
			</div>
		</div>
	</div>
</section>

<style>
	.gal {
		width: 100%;
		padding: 1rem 0;
	}
	.gal img {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
		cursor: pointer;
	}

	.gal.masonry .grid {
		max-width: var(--maxw, 1200px);
		margin: 0 auto;
		padding: 0 1rem;
		display: grid;
		grid-template-columns: repeat(var(--cols-m, 1), 1fr);
		grid-auto-rows: 8px;
		gap: var(--gap, 12px);
	}
	@media (min-width: 640px) {
		.gal.masonry .grid {
			grid-template-columns: repeat(var(--cols-t, 2), 1fr);
		}
	}
	@media (min-width: 1024px) {
		.gal.masonry .grid {
			grid-template-columns: repeat(var(--cols-d, 3), 1fr);
		}
	}
	@media (min-width: 1360px) {
		.gal.masonry .grid {
			grid-template-columns: repeat(var(--cols-w, 4), 1fr);
		}
	}

	.gal.masonry .item {
		position: relative;
		overflow: visible;
	}
	.gal.masonry .grid:hover .item {
		opacity: 0.6;
		filter: saturate(0.9);
		transition:
			opacity 0.15s ease,
			transform 0.15s ease,
			filter 0.15s ease;
	}
	.gal.masonry .grid:hover .item:hover {
		opacity: 1;
		transform: scale(1.02);
		z-index: 2;
	}

	.gal.collage .collage {
		max-width: var(--maxw, 1200px);
		margin: 0 auto;
		padding: 0 1rem;
		display: grid;
		grid-template-columns: repeat(12, 1fr);
		grid-template-rows: repeat(6, minmax(40px, 1fr));
		gap: 0;
	}
	.gal.collage .slot {
		overflow: hidden;
		position: relative;
	}
	.gal.collage .collage:hover .slot {
		opacity: 0.6;
		transition:
			opacity 0.15s ease,
			transform 0.15s ease;
	}
	.gal.collage .collage:hover .slot:hover {
		opacity: 1;
		transform: scale(1.02);
		z-index: 2;
	}

	.gal.collage .s0 {
		grid-column: 1 / span 3;
		grid-row: 1 / span 6;
	} /* alta izq */
	.gal.collage .s1 {
		grid-column: 4 / span 3;
		grid-row: 1 / span 3;
	}
	.gal.collage .s2 {
		grid-column: 4 / span 3;
		grid-row: 4 / span 3;
	}
	.gal.collage .s3 {
		grid-column: 7 / span 6;
		grid-row: 1 / span 4;
	}
	.gal.collage .s4 {
		grid-column: 7 / span 3;
		grid-row: 5 / span 2;
	}
	.gal.collage .s5 {
		grid-column: 10 / span 3;
		grid-row: 5 / span 2;
	}

	@media (max-width: 1024px) {
		.gal.collage .collage {
			grid-template-columns: repeat(6, 1fr);
			grid-template-rows: repeat(12, minmax(30px, 1fr));
		}
		.gal.collage .s0 {
			grid-column: 1 / span 6;
			grid-row: 1 / span 6;
		}
		.gal.collage .s1 {
			grid-column: 1 / span 3;
			grid-row: 7 / span 3;
		}
		.gal.collage .s2 {
			grid-column: 4 / span 3;
			grid-row: 7 / span 3;
		}
		.gal.collage .s3 {
			grid-column: 1 / span 6;
			grid-row: 10 / span 2;
		}
		.gal.collage .s4 {
			grid-column: 1 / span 3;
			grid-row: 12 / span 1;
		}
		.gal.collage .s5 {
			grid-column: 4 / span 3;
			grid-row: 12 / span 1;
		}
	}
	@media (max-width: 640px) {
		.gal.collage .collage {
			grid-template-columns: repeat(2, 1fr);
			grid-template-rows: none;
			gap: 8px;
		}
		.gal.collage .slot {
			grid-column: auto / span 1;
			grid-row: auto;
		}
	}

	.lb.hidden {
		display: none;
	}
	.lb {
		position: fixed;
		inset: 0;
		z-index: 60;
	}
	.backdrop {
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.65);
		backdrop-filter: blur(2px);
	}

	.dialog {
		position: absolute;
		inset: 0;
		display: flex;
		flex-direction: column;
		gap: 12px;
		align-items: center;
		justify-content: center;
		padding: var(--lb-top, 80px) 16px 20px;
		pointer-events: none;
	}

	.card {
		pointer-events: auto;
		background: #fff;
		border-radius: 14px;
		overflow: hidden;
		box-shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
		max-width: min(92vw, 1200px);
		width: 100%;
		display: flex;
		flex-direction: column;
	}
	.stage {
		display: flex;
		align-items: center;
		gap: 8px;
	}
	.media {
		flex: 1;
		background: #fff;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.big {
		max-width: 100%;
		max-height: 65vh;
		object-fit: contain;
	}
	.meta {
		background: #fff;
		color: #222;
		padding: 12px 14px;
		border-top: 1px solid #eee;
	}
	.title {
		font:
			600 15px/1.3 system-ui,
			-apple-system,
			Segoe UI,
			Roboto,
			sans-serif;
		margin-bottom: 6px;
	}
	.desc {
		font:
			400 14px/1.5 system-ui,
			-apple-system,
			Segoe UI,
			Roboto,
			sans-serif;
		color: #444;
		max-height: 18vh;
		overflow: auto;
	}

	.close {
		position: absolute;
		top: calc(var(--lb-top, 80px) - 44px);
		right: 22px;
		pointer-events: auto;
		background: #fff;
		border: 0;
		width: 36px;
		height: 36px;
		border-radius: 50%;
		box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
		color: #333;
		font-size: 22px;
		font-weight: bold;
		line-height: 36px;
		text-align: center;
		cursor: pointer;
	}

	.desktop-only {
		display: none;
	}
	@media (min-width: 768px) {
		.desktop-only {
			display: inline-block;
		}
	}
	.nav {
		pointer-events: auto;
		background: rgba(255, 255, 255, 0.92);
		border: 0;
		cursor: pointer;
		width: 42px;
		height: 60px;
		font-size: 28px;
		line-height: 60px;
		text-align: center;
		color: #222;
		box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
	}

	.thumbs {
		pointer-events: auto;
		width: min(92vw, 1200px);
		display: flex;
		align-items: center;
		gap: 8px;
	}
	.th-btn {
		display: none;
		background: rgba(255, 255, 255, 0.92);
		border: 0;
		cursor: pointer;
		width: 34px;
		height: 48px;
		font-size: 22px;
		color: #222;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	}
	@media (min-width: 768px) {
		.th-btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}
	}

	.th-strip {
		position: relative;
		overflow: auto;
		white-space: nowrap;
		scrollbar-width: thin;
		-webkit-overflow-scrolling: touch;
		flex: 1;
		display: flex;
		gap: 8px;
		padding: 4px;
	}
	.th {
		border: 0;
		background: #000;
		padding: 0;
		cursor: pointer;
		flex: 0 0 var(--thumb-w, 140px);
		aspect-ratio: 3/2;
		overflow: hidden;
		opacity: 0.9;
	}
	.th img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}
	.th[aria-current="true"] {
		outline: 2px solid #333;
		opacity: 1;
	}

	html.no-scroll,
	body.no-scroll {
		overflow: hidden !important;
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const grid = document.querySelector(".gal.masonry .grid");
		if (grid) {
			const items = Array.from(grid.querySelectorAll(".item"));
			const gap =
				parseInt(getComputedStyle(grid).getPropertyValue("gap")) || 12;
			const autoRow =
				parseInt(
					getComputedStyle(grid).getPropertyValue("grid-auto-rows")
				) || 8;

			const resizeItem = (el) => {
				const img = el.querySelector("img");
				if (!img) return;
				const rect = img.getBoundingClientRect();
				const span = Math.ceil((rect.height + gap) / (autoRow + gap));
				el.style.gridRowEnd = `span ${span}`;
			};
			const layout = () => items.forEach(resizeItem);

			items.forEach((el) => {
				const img = el.querySelector("img");
				if (img.complete) resizeItem(el);
				img.addEventListener("load", () => resizeItem(el));
			});
			window.addEventListener("resize", layout);
		}

		const section = document.querySelector(".gal");
		const modal = section.querySelector(".lb");
		const big = modal.querySelector(".big");
		const titleEl = modal.querySelector(".title");
		const descEl = modal.querySelector(".desc");
		const strip = modal.querySelector(".th-strip");
		const thumbs = Array.from(modal.querySelectorAll(".th"));
		const clickables = Array.from(section.querySelectorAll("[data-idx]"));

		let current = -1,
			savedScrollY = 0;

		function lockScroll() {
			savedScrollY = window.scrollY || document.documentElement.scrollTop;
			document.documentElement.classList.add("modal-open", "no-scroll");
			document.body.classList.add("no-scroll");
			document.body.style.position = "fixed";
			document.body.style.top = `-${savedScrollY}px`;
			document.body.style.left = "0";
			document.body.style.right = "0";
		}
		function unlockScroll() {
			document.documentElement.classList.remove(
				"modal-open",
				"no-scroll"
			);
			document.body.classList.remove("no-scroll");
			document.body.style.position = "";
			document.body.style.top = "";
			document.body.style.left = "";
			document.body.style.right = "";
			window.scrollTo(0, savedScrollY);
		}

		function openAt(i) {
			const img = section.querySelector(`img[data-idx="${i}"]`);
			if (!img) return;
			big.src = img.getAttribute("data-src");
			big.alt = img.getAttribute("data-alt") || "";
			titleEl.textContent = img.getAttribute("data-alt") || "";
			descEl.textContent = img.getAttribute("data-desc") || "";
			thumbs.forEach((b) => b.removeAttribute("aria-current"));
			const th = modal.querySelector(`.th[data-idx="${i}"]`);
			if (th) {
				th.setAttribute("aria-current", "true");
				const left =
					th.offsetLeft -
					(strip.clientWidth / 2 - th.clientWidth / 2);
				strip.scrollTo({ left, behavior: "smooth" });
			}
			modal.classList.remove("hidden");
			lockScroll();
			current = i;
		}
		function close() {
			modal.classList.add("hidden");
			big.src = "";
			unlockScroll();
			current = -1;
		}
		function prev() {
			if (current < 0) return;
			openAt((current - 1 + clickables.length) % clickables.length);
		}
		function next() {
			if (current < 0) return;
			openAt((current + 1) % clickables.length);
		}

		clickables.forEach((el) =>
			el.addEventListener("click", () =>
				openAt(Number(el.getAttribute("data-idx")))
			)
		);
		modal.addEventListener("click", (e) => {
			const t = e.target;
			if (!(t instanceof HTMLElement)) return;

			if (
				t.classList.contains("backdrop") ||
				t.dataset.action === "close"
			) {
				close();
				return;
			}
			if (t.closest(".card") || t.closest(".thumbs")) {
				e.stopPropagation();
			}

			const a = t.dataset.action;
			if (a === "prev") prev();
			if (a === "next") next();
			if (a === "thumb-prev")
				strip.scrollBy({
					left: -strip.clientWidth,
					behavior: "smooth",
				});
			if (a === "thumb-next")
				strip.scrollBy({ left: strip.clientWidth, behavior: "smooth" });
		});

		window.addEventListener("keydown", (e) => {
			if (modal.classList.contains("hidden")) return;
			if (e.key === "Escape") close();
			if (e.key === "ArrowLeft") prev();
			if (e.key === "ArrowRight") next();
		});

		thumbs.forEach((b) =>
			b.addEventListener("click", (e) => {
				e.stopPropagation();
				const idx = Number(b.getAttribute("data-idx") || -1);
				if (idx >= 0) openAt(idx);
			})
		);
	});
</script>
