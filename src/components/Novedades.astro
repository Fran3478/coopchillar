---
interface Item {
	slug: string;
	title: string;
	imageUrl?: string;
	date?: string;
	category?: string;
}
const { novedades = [], noticias = [] } = Astro.props as {
	novedades: Item[];
	noticias: Item[];
};

function fmt(d?: string) {
	if (!d) return "";
	const dt = new Date(d);
	return new Intl.DateTimeFormat("es-AR", {
		day: "2-digit",
		month: "short",
	}).format(dt);
}
const imgOr = (fallback: string) => (url?: string) => url || fallback;
const fallbackNews = "/images/slide1.webp";
const fallbackBlog = "/images/factura-electronica.webp";
const safeNewsImg = imgOr(fallbackNews);
const safeBlogImg = imgOr(fallbackBlog);
---

<div class="noticias-y-blog">
	<div class="news-carousel" id="news-carousel">
		<div class="carousel-wrapper">
			{
				novedades.map((n) => (
					<div class="news-highlight">
						<img
							src={safeNewsImg(n.imageUrl)}
							alt={n.title}
							class="news-image"
						/>
						<div class="news-overlay">
							<div class="news-card">
								<p class="news-title">{n.title}</p>
								<div class="news-footer">
									<span>{fmt(n.date)}</span>

									{n.kind === "noticia" ? (
										<a href={`/noticias/${n.slug}`}>
											Conoce m√°s <span>&rarr;</span>
										</a>
									) : n.externalUrl ? (
										<a
											href={n.externalUrl}
											target="_blank"
											rel="noopener"
										>
											Conoce m√°s <span>&rarr;</span>
										</a>
									) : null}
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
		{
			novedades.length === 0 && (
				<div class="empty-box">
					<span class="empty-icon" aria-hidden="true">
						üóûÔ∏è
					</span>
					<p class="empty-title">A√∫n no hay novedades</p>
					<p class="empty-sub">
						Cuando publiques una novedad, aparecer√° aqu√≠ como
						destacada.
					</p>
				</div>
			)
		}

		{
			novedades.length > 1 && (
				<div class="news-arrows">
					<button class="arrow-btn" id="prev">
						&#x276E;
					</button>
					<button class="arrow-btn" id="next">
						&#x276F;
					</button>
				</div>
			)
		}
	</div>

	<div class="blog-sidebar">
		<h3 class="blog-title">Noticias</h3>
		<div class="blog-carousel">
			{
				noticias.length === 0 ? (
					<div class="empty-list">
						<span class="empty-icon" aria-hidden="true">
							üì∞
						</span>
						<p class="empty-title">Todav√≠a no hay noticias</p>
						<p class="empty-sub">
							Public√° tu primera noticia para mostrarla en este
							listado.
						</p>
					</div>
				) : (
					<>
						<div class="blog-entries" id="blog-entries">
							{noticias.map((p) => (
								<div class="blog-entry">
									<img
										src={safeBlogImg(p.imageUrl)}
										alt={p.title}
									/>
									<div>
										<p class="blog-entry-title">
											<a
												href={`/noticias/${p.slug}`}
												style="color:inherit;text-decoration:none"
											>
												{p.title}
											</a>
										</p>
										{p.category && (
											<p class="blog-entry-category">
												{p.category}
											</p>
										)}
										<p class="blog-entry-date">
											{fmt(p.date)}
										</p>
									</div>
								</div>
							))}
						</div>

						{noticias.length > 5 && (
							<div class="blog-arrows" id="blog-arrows">
								<button class="blog-arrow" id="blog-prev">
									&#x25B2;
								</button>
								<button class="blog-arrow" id="blog-next">
									&#x25BC;
								</button>
							</div>
						)}
					</>
				)
			}
		</div>

		<a href="/noticias" class="ver-todo-btn">VER TODO &rarr;</a>
	</div>
</div>

<style>
	.noticias-y-blog {
		display: flex;
		flex-wrap: wrap;
		gap: 2rem;
		max-width: 1600px;
		margin: 0 auto;
		align-items: flex-start;
	}

	.news-carousel {
		flex: 1 1 65%;
		max-width: 60%;
		position: relative;
		overflow: hidden;
		border-radius: 16px;
		aspect-ratio: 16 / 9;
		background: #f3f4f6;
	}

	.carousel-wrapper {
		display: flex;
		height: 100%;
		transition: transform 0.6s ease-in-out;
	}
	.news-highlight {
		min-width: 100%;
		position: relative;
		height: 100%;
	}

	.news-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		object-position: center;
		display: block;
		border-radius: 0;
		background: #f3f4f6;
	}

	.news-overlay {
		position: absolute;
		inset: 0;
		z-index: 1;
	}
	.news-card {
		position: absolute;
		bottom: 1rem;
		right: 1rem;
		background-color: #004481;
		color: #fff;
		padding: 1.5rem;
		border-radius: 20px;
		max-width: 340px;
		z-index: 2;
	}

	.news-title {
		font-size: 1rem;
		line-height: 1.4;
	}
	.news-footer {
		display: flex;
		justify-content: space-between;
		font-size: 0.85rem;
		font-weight: 600;
	}
	.news-footer a {
		color: white;
		text-decoration: none;
	}

	.news-arrows {
		position: absolute;
		inset: 0;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0 0.5rem;
		z-index: 3;
		pointer-events: none;
	}
	.arrow-btn {
		pointer-events: auto;
		background: #ff8c00;
		border: none;
		color: #fff;
		font-size: 1.2rem;
		width: 42px;
		height: 42px;
		border-radius: 50%;
		cursor: pointer;
		transition:
			filter 0.15s ease,
			transform 0.1s ease;
		box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
	}
	.arrow-btn:hover {
		filter: brightness(0.95);
		transform: translateY(-1px);
	}
	.arrow-btn:active {
		transform: translateY(0);
	}

	.blog-sidebar {
		flex: 1 1 33%;
		max-width: 33%;
	}
	.blog-title {
		color: #004481;
		font-weight: bold;
		font-size: 1.2rem;
		margin-bottom: 1rem;
	}
	.blog-carousel {
		position: relative;
		flex: 1;
		overflow: hidden;
		max-height: 490px;
	}
	.blog-entries {
		display: flex;
		flex-direction: column;
		transition: transform 0.5s ease;
	}
	.blog-entry {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
		align-items: center;
		height: 80px;
	}
	.blog-entry img {
		width: 80px;
		height: 60px;
		object-fit: cover;
		border-radius: 12px;
	}
	.blog-entry-title {
		font-weight: bold;
		font-size: 0.95rem;
		margin: 0;
		color: #333;
	}
	.blog-entry-category {
		font-size: 0.8rem;
		color: #888;
		margin: 0.2rem 0;
	}
	.blog-entry-date {
		font-size: 0.75rem;
		color: #666;
		margin: 0;
	}

	.blog-arrows {
		position: absolute;
		top: 0.5rem;
		right: 0;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}
	.blog-arrow {
		background-color: orange;
		color: white;
		border: none;
		width: 32px;
		height: 32px;
		border-radius: 50%;
		cursor: pointer;
		opacity: 0.8;
	}
	.blog-arrow:hover {
		opacity: 1;
	}

	.ver-todo-btn {
		display: inline-block;
		background-color: #004481;
		color: white;
		text-decoration: none;
		padding: 0.6rem 1.2rem;
		border-radius: 999px;
		font-weight: bold;
		font-size: 0.9rem;
		transition: background 0.3s ease;
	}
	.ver-todo-btn:hover {
		background-color: #0060b4;
	}

	.empty-box,
	.empty-list {
		box-sizing: border-box;
		width: 100%;
		min-height: 220px;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 0.25rem;
		background: #f7f8fb;
		border: 1px dashed #d8dbe5;
		border-radius: 15px;
		text-align: center;
		color: #556;
		padding: 1.25rem;
	}

	.empty-list {
		min-height: 240px;
	}
	.empty-icon {
		font-size: 28px;
		opacity: 0.7;
	}
	.empty-title {
		margin: 0.25rem 0 0;
		font-weight: 700;
		color: #223;
	}
	.empty-sub {
		margin: 0;
		font-size: 0.9rem;
		color: #667;
	}

	@media (max-width: 1070px) {
		.noticias-y-blog {
			flex-direction: column;
		}
		.news-carousel,
		.blog-sidebar {
			max-width: 100%;
		}
	}
</style>

<script>
	/** @type {HTMLElement|null} */
	const wrapper = document.querySelector(".carousel-wrapper");
	/** @type {NodeListOf<HTMLElement>} */
	const slides = document.querySelectorAll(".news-highlight");
	/** @type {HTMLButtonElement|null} */
	const prevBtn = document.getElementById("prev");
	/** @type {HTMLButtonElement|null} */
	const nextBtn = document.getElementById("next");

	/** @type {number} */ let index = 0;
	/** @type {number|null} */ let autoSlideInterval = null;

	function updateCarousel() {
		if (!wrapper) return;
		const offset = -index * 100;
		wrapper.style.transform = `translateX(${offset}%)`;
	}
	function nextSlide() {
		const total = slides.length;
		if (!total) return;
		index = (index + 1) % total;
		updateCarousel();
	}
	function prevSlide() {
		const total = slides.length;
		if (!total) return;
		index = (index - 1 + total) % total;
		updateCarousel();
	}
	function startAutoSlide() {
		if (slides.length > 1 && autoSlideInterval === null) {
			autoSlideInterval = window.setInterval(nextSlide, 8000);
		}
	}
	function resetAutoSlide() {
		if (autoSlideInterval !== null) {
			window.clearInterval(autoSlideInterval);
			autoSlideInterval = null;
		}
		startAutoSlide();
	}

	nextBtn?.addEventListener("click", () => {
		nextSlide();
		resetAutoSlide();
	});
	prevBtn?.addEventListener("click", () => {
		prevSlide();
		resetAutoSlide();
	});

	// Swipe m√≥vil
	/** @type {number} */ let startX = 0;
	/** @type {boolean} */ let isDragging = false;

	wrapper?.addEventListener("touchstart", (e) => {
		startX = e.touches[0].clientX;
		isDragging = true;
	});
	wrapper?.addEventListener("touchmove", (e) => {
		if (!isDragging) return;
		const diffX = e.touches[0].clientX - startX;
		if (Math.abs(diffX) > 50) {
			diffX < 0 ? nextSlide() : prevSlide();
			resetAutoSlide();
			isDragging = false;
		}
	});
	wrapper?.addEventListener("touchend", () => {
		isDragging = false;
	});

	updateCarousel();
	startAutoSlide();

	/** @type {HTMLElement|null} */
	const blogEntries = document.getElementById("blog-entries");
	/** @type {HTMLButtonElement|null} */
	const blogPrev = document.getElementById("blog-prev");
	/** @type {HTMLButtonElement|null} */
	const blogNext = document.getElementById("blog-next");
	/** @type {HTMLElement|null} */
	const blogArrows = document.getElementById("blog-arrows");

	/** @type {number} */ const entryHeight = 90;
	/** @type {number} */ let blogIndex = 0;
	/** @type {number} */ const totalEntries = blogEntries
		? blogEntries.children.length
		: 0;
	/** @type {number} */ const maxVisible = 5;
	/** @type {number|null} */ let autoScrollInterval = null;

	function updateBlog() {
		if (!blogEntries) return;
		blogEntries.style.transform = `translateY(${-blogIndex * entryHeight}px)`;
	}
	function startAuto() {
		if (totalEntries > maxVisible && autoScrollInterval === null) {
			autoScrollInterval = window.setInterval(() => {
				blogIndex = (blogIndex + 1) % (totalEntries - maxVisible + 1);
				updateBlog();
			}, 5000);
		}
	}
	function stopAuto() {
		if (autoScrollInterval !== null) {
			window.clearInterval(autoScrollInterval);
			autoScrollInterval = null;
		}
	}

	blogNext?.addEventListener("click", () => {
		if (blogIndex < totalEntries - maxVisible) {
			blogIndex++;
			updateBlog();
			stopAuto();
			startAuto();
		}
	});
	blogPrev?.addEventListener("click", () => {
		if (blogIndex > 0) {
			blogIndex--;
			updateBlog();
			stopAuto();
			startAuto();
		}
	});

	if (blogArrows) {
		blogArrows.style.display = totalEntries > maxVisible ? "flex" : "none";
	}

	updateBlog();
	startAuto();
</script>
