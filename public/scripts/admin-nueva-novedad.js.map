{"version":3,"file":"admin-nueva-novedad.js","sources":["../../src/scripts/admin-nueva-novedad.ts"],"sourcesContent":["import { apiPost, getErrorInfo, toErrorText } from \"../lib/api\";\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  void main();\r\n});\r\n\r\nasync function main() {\r\n  const DEFAULT_FOLDER = \"novedades\";\r\n  const RESOURCE_TYPE = \"image\";\r\n\r\n  const tituloEl = document.getElementById(\"titulo\") as HTMLInputElement | null;\r\n  const portadaEl = document.getElementById(\"portadaUrl\") as HTMLInputElement | null;\r\n  const fileEl = document.getElementById(\"portadaFile\") as HTMLInputElement | null;\r\n  const linkUrlEl = document.getElementById(\"linkUrl\") as HTMLInputElement | null;\r\n  const saveBtn = document.getElementById(\"saveBtn\") as HTMLButtonElement | null;\r\n\r\n  if (!tituloEl || !portadaEl || !fileEl || !linkUrlEl || !saveBtn) {\r\n    console.warn(\"[admin-nueva-novedad] faltan elementos del DOM\");\r\n    return;\r\n  }\r\n\r\n  function toast(msg: string, type: \"\" | \"ok\" | \"err\" = \"\") {\r\n    const el = document.getElementById(\"status\");\r\n    if (!el) return;\r\n    el.textContent = msg;\r\n    el.className = `status show ${type}`;\r\n    if (type === \"ok\") setTimeout(() => (el.className = \"status\"), 1600);\r\n  }\r\n\r\n  async function requestSignature(payload: {\r\n    resourceType: string;\r\n    folder?: string;\r\n    publicId?: string;\r\n    incomingTransform?: string;\r\n    eager?: string;\r\n  }) {\r\n    const res = await apiPost(\"/v1/media/sign\", payload);\r\n    if (!res.ok) throw new Error(\"No se pudo obtener la firma\");\r\n    return res.json();\r\n  }\r\n\r\n  async function uploadToCloudinary(file: File, sig: any, publicId?: string) {\r\n    const cloudName = sig.cloudName;\r\n    const resourceType = sig.resourceType || \"image\";\r\n    const url = `https://api.cloudinary.com/v1_1/${cloudName}/${resourceType}/upload`;\r\n\r\n    const form = new FormData();\r\n    form.append(\"file\", file);\r\n    form.append(\"api_key\", String(sig.apiKey));\r\n    form.append(\"timestamp\", String(sig.timestamp));\r\n    form.append(\"signature\", String(sig.signature));\r\n    if (sig.folder) form.append(\"folder\", sig.folder);\r\n    if (publicId) form.append(\"public_id\", publicId);\r\n    if (sig.transformation) form.append(\"transformation\", sig.transformation);\r\n    if (sig.eager) form.append(\"eager\", sig.eager);\r\n\r\n    const r = await fetch(url, { method: \"POST\", body: form });\r\n    if (!r.ok) throw new Error(`Error subiendo a Cloudinary (${r.status})`);\r\n    return r.json();\r\n  }\r\n\r\n  fileEl.addEventListener(\"change\", async () => {\r\n    const file = fileEl.files?.[0];\r\n    if (!file) return;\r\n\r\n    if (!/^image\\//.test(file.type)) return toast(\"Formato no soportado\", \"err\");\r\n    if (file.size > 10 * 1024 * 1024) return toast(\"La imagen supera 10MB\", \"err\");\r\n\r\n    try {\r\n      toast(\"Subiendo imagen…\");\r\n\r\n      const sig = await requestSignature({\r\n        resourceType: RESOURCE_TYPE,\r\n        folder: DEFAULT_FOLDER,\r\n        incomingTransform: \"c_limit,w_2560/f_webp,q_auto:good\",\r\n        // eager: \"c_fill,w_1200\"\r\n      });\r\n\r\n      const resp = await uploadToCloudinary(file, sig);\r\n      portadaEl.value = resp.secure_url || \"\";\r\n      toast(\"Imagen subida ✅\", \"ok\");\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast(\"No se pudo subir la imagen\", \"err\");\r\n    }\r\n  });\r\n\r\n  saveBtn.addEventListener(\"click\", async () => {\r\n    try {\r\n      const titulo = (tituloEl.value || \"\").trim();\r\n      const portada = (portadaEl.value || \"\").trim();\r\n      const link = (linkUrlEl.value || \"\").trim();\r\n\r\n      if (!titulo) throw new Error(\"Falta el título\");\r\n      if (!portada) throw new Error(\"Agregá una portada\");\r\n\r\n      const body: any = {\r\n        tipo: \"novedad\",\r\n        titulo,\r\n        excerpt: \"\",\r\n        destacado: true,\r\n        blocksJson: { time: Date.now(), blocks: [] },\r\n        ...(portada ? { portadaUrl: portada } : {}),\r\n        ...(link ? { linkUrl: link } : {}),\r\n      };\r\n\r\n      toast(\"Guardando…\");\r\n      const res = await apiPost(\"/v1/posts\", body);\r\n      if (!res.ok) {\r\n        const { text } = await getErrorInfo(res);\r\n        throw new Error(text);\r\n      }\r\n\r\n      toast(\"Guardado ✅\", \"ok\");\r\n      localStorage.removeItem(\"cms:contenido:draft\");\r\n      location.href = \"/admin/novedades\";\r\n    } catch (e) {\r\n      console.error(e);\r\n      toast(toErrorText(e), \"err\");\r\n    }\r\n  });\r\n}\r\n"],"names":["main","DEFAULT_FOLDER","RESOURCE_TYPE","tituloEl","portadaEl","fileEl","linkUrlEl","saveBtn","toast","msg","type","el","requestSignature","payload","res","apiPost","uploadToCloudinary","file","sig","publicId","cloudName","resourceType","url","form","r","_a","resp","err","titulo","portada","link","body","text","getErrorInfo","e","toErrorText"],"mappings":"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"}