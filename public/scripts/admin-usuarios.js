import{h as Z,b as _,a as K,g as $,c as P,t as ee}from"./chunks/api-gnd9IJTx.js";import{d as te,m as L}from"./chunks/admin-uploader-l2mfM3fY.js";document.addEventListener("DOMContentLoaded",()=>{ae()});const r=te("status",{okMs:1600,errMs:5e3});let a=null,k=!1,v=1;const G=10;let A=0,H="",U="",B=[];const g=document.getElementById("rows"),O=document.getElementById("pageInfo"),h=document.getElementById("prev"),y=document.getElementById("next"),S=document.getElementById("newBtn"),q=document.getElementById("q"),x=document.getElementById("roleFilter"),i=document.getElementById("userModal"),z=document.getElementById("userForm"),R=document.getElementById("userFormTitle"),T=document.getElementById("userId"),m=document.getElementById("email"),f=document.getElementById("role"),D=document.getElementById("cancelUser"),u=document.getElementById("resetModal"),N=document.getElementById("resetToken"),C=document.getElementById("copyToken"),V=document.getElementById("tokenExp"),M=document.getElementById("closeReset");function oe(e){return e==="admin"||e==="owner"}function Q(e){if(typeof(e==null?void 0:e.active)=="boolean")return e.active;const t=String((e==null?void 0:e.status)||"").toLowerCase();return t?t!=="blocked":!0}function re(e){return String((e==null?void 0:e.status)||(Q(e)?"active":"blocked")).toLowerCase()==="blocked"?'<span class="badge inactive">Bloqueado</span>':'<span class="badge active">Activo</span>'}function ne(e){return`<span class="badge role-${e}">${Y(e)}</span>`}function W(){!m||!f||[m,f].forEach(e=>{var o;e.classList.remove("invalid","is-invalid");const t=e.closest("label")||e.parentElement;(o=t==null?void 0:t.querySelectorAll(".err-tip"))==null||o.forEach(s=>s.remove()),e.removeAttribute("aria-invalid"),e.removeAttribute("aria-describedby")})}let F={email:"",role:"editor"};async function ae(){var e;try{a=await Z(),k=oe(String(((e=a==null?void 0:a.user)==null?void 0:e.role)||"")),k&&(S==null||S.removeAttribute("disabled")),se(),await p()}catch(t){r.show("No se pudo cargar usuarios","err"),console.error(t)}}function se(){q==null||q.addEventListener("input",de(()=>{H=(q.value||"").trim(),v=1,p()},300)),x==null||x.addEventListener("change",()=>{U=x.value,v=1,p()}),h==null||h.addEventListener("click",()=>{v>1&&(v--,p())}),y==null||y.addEventListener("click",()=>{const e=Math.max(1,Math.ceil(A/G));v<e&&(v++,p())}),S==null||S.addEventListener("click",()=>X()),D==null||D.addEventListener("click",()=>i==null?void 0:i.close()),z==null||z.addEventListener("submit",le),i==null||i.addEventListener("click",e=>{e.target===i&&i.close()}),u==null||u.addEventListener("click",e=>{e.target===u&&u.close()}),C==null||C.addEventListener("click",async()=>{try{if(!N)return;await navigator.clipboard.writeText(N.value),r.show("Copiado ✅","ok")}catch{r.show("No se pudo copiar","err")}}),M==null||M.addEventListener("click",()=>u==null?void 0:u.close())}async function p(){try{if(!g||!O||!h||!y)return;g.innerHTML='<tr><td colspan="4" class="empty">Cargando…</td></tr>';const e=new URLSearchParams({page:String(v),pageSize:String(G),...H?{q:H}:{},...U?{role:U}:{}}).toString(),t=await _(`/v1/users?${e}`);if(!t.ok)throw new Error(await t.text());const o=await t.json();A=o.total||0,B=Array.isArray(o.items)?o.items:[],B.length?(g.innerHTML=B.map(n=>ie(n)).join(""),g.querySelectorAll("[data-action='edit']").forEach(n=>n.addEventListener("click",()=>X(n.dataset.id||null,B.find(E=>String(E.id)===String(n.dataset.id))))),g.querySelectorAll(".act-block").forEach(n=>n.addEventListener("click",()=>J(n.dataset.id||"",!1))),g.querySelectorAll(".act-unblock").forEach(n=>n.addEventListener("click",()=>J(n.dataset.id||"",!0))),g.querySelectorAll(".act-reset").forEach(n=>n.addEventListener("click",()=>ce(n.dataset.id||"")))):g.innerHTML='<tr><td colspan="4" class="empty">Sin resultados</td></tr>';const s=Math.max(1,Math.ceil(A/G));O.textContent=`Página ${v} de ${s} • ${A} usuarios`;const l=v<=1,c=v>=s;h.disabled=l,y.disabled=c,h.setAttribute("aria-disabled",String(l)),y.setAttribute("aria-disabled",String(c))}catch(e){console.error(e),g&&(g.innerHTML='<tr><td colspan="4" class="empty">Error cargando usuarios</td></tr>')}}function ie(e){const o=Q(e)?`<button class="kbtn danger solid act-block" data-id="${e.id}">Bloquear</button>`:`<button class="kbtn success solid act-unblock" data-id="${e.id}">Desbloquear</button>`,s=k?`<div class="row-actions">
        <button class="kbtn" data-action="edit" data-id="${e.id}">Editar</button>
        ${o}
        <button class="kbtn ghost act-reset" data-id="${e.id}">Blanquear</button>
      </div>`:'<span class="muted">—</span>';return`<tr>
    <td>${Y(e.email||"")}</td>
    <td>${ne(e.role||"editor")}</td>
    <td class="hidem">${re(e)}</td>
    <td class="td actions">${s}</td>
  </tr>`}function X(e=null,t=null){var l,c;if(!T||!m||!f||!R||!i)return;W(),T.value=e?String(e):"",m.value=(t==null?void 0:t.email)||"",f.value=(t==null?void 0:t.role)||"editor",F={email:m.value,role:String(f.value||"editor")};const o=(l=a==null?void 0:a.user)!=null&&l.id?String(a.user.id):null;o&&e&&String(e)===o&&((c=a==null?void 0:a.user)==null?void 0:c.role)!=="owner"?f.setAttribute("disabled","true"):f.removeAttribute("disabled"),R.textContent=e?"Editar usuario":"Nuevo usuario",k&&i.showModal()}async function le(e){var l,c;if(e.preventDefault(),!m||!f||!T||!i)return;W();const t=T.value||null,o=(m.value||"").trim(),s=String(f.value||"editor");if(!o){L(m,"El email es obligatorio");return}if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(o)){L(m,"Email inválido");return}try{if(!t){r.show("Creando…");const d=await K("/v1/users",{email:o,role:s});if(!d.ok){const{text:b,fieldErrors:I}=await $(d);return I.forEach(w=>{const j=w.field==="email"?m:w.field==="role"?f:null;j&&L(j,w.message||"Dato inválido")}),r.show(b||"Error","err")}r.show("Creado ✅","ok"),i.close(),await p();return}const n=(l=a==null?void 0:a.user)!=null&&l.id?String(a.user.id):null,E=n&&String(t)===n;if(o!==F.email){r.show("Actualizando email…");const d=await P(`/v1/users/${t}/email`,{email:o});if(!d.ok){const{text:b,fieldErrors:I}=await $(d);return I.forEach(w=>w.field==="email"&&L(m,w.message||"Dato inválido")),r.show(b||"No se pudo actualizar el email","err")}}if(s!==F.role){if(!k)return r.show("No autorizado para cambiar rol","err");if(E&&((c=a==null?void 0:a.user)==null?void 0:c.role)!=="owner")return r.show("No podés cambiar tu propio rol (salvo owner)","err");r.show("Actualizando rol…");const d=await P(`/v1/users/${t}/role`,{role:s});if(!d.ok){const{text:b,fieldErrors:I}=await $(d);return I.forEach(w=>w.field==="role"&&L(f,w.message||"Dato inválido")),r.show(b||"No se pudo actualizar el rol","err")}}r.show("Guardado ✅","ok"),i.close(),await p()}catch(n){console.error(n),r.show(ee(n),"err")}}async function J(e,t){var n;if(!k)return r.show("No autorizado","err");const o=B.find(E=>String(E.id)===String(e));if(!o)return;const s=(n=a==null?void 0:a.user)!=null&&n.id?String(a.user.id):null;if(s&&String(o.id)===s)return r.show("No podés bloquearte a vos mismo","err");if(o.role==="owner"&&t===!1)return r.show("No se puede bloquear un Owner","err");if(confirm(`${t?"Desbloquear":"Bloquear"} a ${o.email}?`))try{r.show(t?"Desbloqueando…":"Bloqueando…");const E=t?"active":"blocked",d=await P(`/v1/users/${e}/status`,{status:E});if(!d.ok){const{text:b}=await $(d);return r.show(b||"No se pudo actualizar el estado","err")}await p(),r.show("Estado actualizado ✅","ok")}catch(E){console.error(E),r.show("No se pudo actualizar el estado","err")}}async function ce(e){if(!(!k||!confirm("¿Generar token de blanqueo para este usuario?")))try{r.show("Generando token…");const o=await K(`/v1/users/${e}/recovery-token`);if(!o.ok){const{text:c}=await $(o);r.show(c||"No se pudo generar el token","err");return}const{token:s,expiresAt:l}=await o.json();N&&(N.value=s||""),V&&(V.textContent=l?"Vence: "+new Date(l).toLocaleString():""),u==null||u.showModal(),r.clear()}catch(o){console.error(o),r.show("No se pudo generar el token","err")}}function de(e,t=300){let o;return(...s)=>{clearTimeout(o),o=setTimeout(()=>e(...s),t)}}function Y(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[t])}
//# sourceMappingURL=admin-usuarios.js.map
