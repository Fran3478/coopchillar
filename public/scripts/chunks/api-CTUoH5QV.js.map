{"version":3,"file":"api-CTUoH5QV.js","sources":["../../../src/lib/api.ts"],"sourcesContent":["function getCookie(name: string) {\r\n  const pairs = document.cookie ? document.cookie.split(\"; \") : [];\r\n  for (const pair of pairs) {\r\n    const eq = pair.indexOf(\"=\");\r\n    const key = eq > -1 ? pair.slice(0, eq) : pair;\r\n    if (key === name) return decodeURIComponent(eq > -1 ? pair.slice(eq + 1) : \"\");\r\n  }\r\n  return null;\r\n}\r\nfunction setCookie(name: string, value: string) {\r\n  document.cookie = `${name}=${encodeURIComponent(value)}; Path=/; SameSite=Lax`;\r\n}\r\n\r\nlet refreshInFlight: Promise<string | null> | null = null;\r\n\r\nasync function doRefresh(): Promise<string | null> {\r\n  const res = await fetch(\"/v1/auth/refresh\", {\r\n    method: \"POST\",\r\n    credentials: \"include\",\r\n  });\r\n  if (!res.ok) return null;\r\n  const j = await res.json().catch(() => null);\r\n  const token: string | undefined = j?.token;\r\n  if (!token) return null;\r\n  setCookie(\"access_token\", token);\r\n  return token;\r\n}\r\nfunction refreshAccessToken(): Promise<string | null> {\r\n  if (!refreshInFlight) {\r\n    refreshInFlight = doRefresh().finally(() => {\r\n      refreshInFlight = null;\r\n    });\r\n  }\r\n  return refreshInFlight;\r\n}\r\n\r\nconst FIELD_LABELS: Record<string, string> = {\r\n  email: \"Email\",\r\n  password: \"Contraseña\",\r\n  tipo: \"Tipo de publicación\",\r\n  titulo: \"Título\",\r\n  excerpt: \"Resumen\",\r\n  portadaUrl: \"URL de la portada\",\r\n  linkUrl: \"Enlace externo\",\r\n  destacado: \"Destacado\",\r\n  blocksJson: \"Contenido\",\r\n  estado: \"Estado\",\r\n  slug: \"Slug\",\r\n};\r\n\r\nexport function humanizeField(raw: string | undefined): string {\r\n  if (!raw) return \"Campo\";\r\n  const last = raw.split(\".\").pop()!;\r\n  if (FIELD_LABELS[last]) return FIELD_LABELS[last];\r\n  const pretty = last.replace(/([A-Z])/g, \" $1\").replace(/_/g, \" \").trim();\r\n  return pretty.replace(/\\burl\\b/i, \"URL\").replace(/^\\w/, (m) => m.toUpperCase());\r\n}\r\n\r\nexport function toErrorText(e: unknown): string {\r\n  if (!e) return \"Error desconocido\";\r\n  if (typeof e === \"string\") return e;\r\n  if (e instanceof Error) return e.message || \"Error\";\r\n  try {\r\n    const j = typeof e === \"object\" ? (e as any) : JSON.parse(String(e));\r\n    if (j?.error) {\r\n      const msg = j.error.message || \"Error\";\r\n      const det = Array.isArray(j.error.details) ? j.error.details[0] : null;\r\n      if (det) {\r\n        const field = det.field || (Array.isArray(det.path) ? det.path.at(-1) : \"\");\r\n        const label = humanizeField(field);\r\n        const m = det.message || msg;\r\n        return `${m}: ${label}`;\r\n      }\r\n      return msg;\r\n    }\r\n    if (j?.message) return j.message;\r\n    return JSON.stringify(j);\r\n  } catch {\r\n    return String(e);\r\n  }\r\n}\r\n\r\nexport async function getErrorInfo(\r\n  res: Response\r\n): Promise<{ text: string; fieldErrors: Array<{ field: string; label: string; message: string }> }> {\r\n  let text = `Error ${res.status}`;\r\n  const fieldErrors: Array<{ field: string; label: string; message: string }> = [];\r\n  try {\r\n    const j = await res.json();\r\n    const err = j?.error ?? j;\r\n    const baseMsg = err?.message || text;\r\n\r\n    if (Array.isArray(err?.details) && err.details.length) {\r\n      for (const d of err.details) {\r\n        const field = d.field || (Array.isArray(d.path) ? d.path.at(-1) : \"\");\r\n        const label = humanizeField(field);\r\n        const message = d.message || baseMsg || \"Dato inválido\";\r\n        fieldErrors.push({ field, label, message });\r\n      }\r\n      const first = fieldErrors[0];\r\n      text = `${first.message}: ${first.label}`;\r\n    } else if (typeof baseMsg === \"string\") {\r\n      text = baseMsg;\r\n    }\r\n  } catch {\r\n  }\r\n  return { text, fieldErrors };\r\n}\r\n\r\nexport async function getErrorText(res: Response): Promise<string> {\r\n  const { text } = await getErrorInfo(res);\r\n  return text;\r\n}\r\n\r\nexport function applyFieldErrors(\r\n  errors: Array<{ field: string; label: string; message: string }>,\r\n  opts: { root?: ParentNode; scroll?: boolean } = {}\r\n) {\r\n  const root = opts.root || document;\r\n  root.querySelectorAll(\".invalid\").forEach((el) => el.classList.remove(\"invalid\"));\r\n  root.querySelectorAll(\".err-tip\").forEach((el) => el.remove());\r\n\r\n  for (const { field, message } of errors) {\r\n    if (!field) continue;\r\n    const sel = [\r\n      `#${CSS.escape(field)}`,\r\n      `[name=\"${CSS.escape(field)}\"]`,\r\n      `[data-field=\"${CSS.escape(field)}\"]`,\r\n    ].join(\",\");\r\n\r\n    const input = root.querySelector<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>(sel);\r\n    if (!input) continue;\r\n\r\n    input.classList.add(\"invalid\");\r\n    input.setAttribute(\"aria-invalid\", \"true\");\r\n\r\n    const tip = document.createElement(\"small\");\r\n    tip.className = \"err-tip\";\r\n    tip.textContent = message;\r\n    const fieldWrap = input.closest(\".field\") || input.parentElement || input;\r\n    fieldWrap.appendChild(tip);\r\n\r\n    if (opts.scroll) {\r\n      input.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\r\n    }\r\n  }\r\n}\r\n\r\nexport async function apiFetch(path: string, init: RequestInit = {}) {\r\n  const headers = new Headers(init.headers || {});\r\n  const isForm = typeof FormData !== \"undefined\" && init.body instanceof FormData;\r\n\r\n  if (!isForm && init.body != null && !headers.has(\"Content-Type\")) {\r\n    headers.set(\"Content-Type\", \"application/json\");\r\n  }\r\n\r\n  const token = getCookie(\"access_token\");\r\n  if (token && !headers.has(\"Authorization\")) {\r\n    headers.set(\"Authorization\", `Bearer ${token}`);\r\n  }\r\n\r\n  const csrf = getCookie(\"csrf\");\r\n  if (csrf && !headers.has(\"x-csrf-token\")) {\r\n    headers.set(\"x-csrf-token\", csrf);\r\n  }\r\n\r\n  let res = await fetch(path, { ...init, headers, credentials: init.credentials ?? \"include\" });\r\n\r\n  if (res.status !== 401 || path.startsWith(\"/v1/auth/\")) return res;\r\n\r\n  const newToken = await refreshAccessToken();\r\n  if (!newToken) return res;\r\n\r\n  const retriedHeaders = new Headers(headers);\r\n  retriedHeaders.set(\"Authorization\", `Bearer ${newToken}`);\r\n  return fetch(path, { ...init, headers: retriedHeaders, credentials: init.credentials ?? \"include\" });\r\n}\r\n\r\nexport const apiGet = (path: string, init: RequestInit = {}) =>\r\n  apiFetch(path, { ...init, method: \"GET\" });\r\n\r\nexport const apiPost = (path: string, body?: unknown, init: RequestInit = {}) =>\r\n  apiFetch(path, {\r\n    ...init,\r\n    method: \"POST\",\r\n    body: body instanceof FormData ? body : body != null ? JSON.stringify(body) : undefined,\r\n  });\r\n\r\nexport const apiPut = (path: string, body?: unknown, init: RequestInit = {}) =>\r\n  apiFetch(path, {\r\n    ...init,\r\n    method: \"PUT\",\r\n    body: body instanceof FormData ? body : body != null ? JSON.stringify(body) : undefined,\r\n  });\r\n\r\nexport const apiPatch = (path: string, body?: unknown, init: RequestInit = {}) =>\r\n  apiFetch(path, {\r\n    ...init,\r\n    method: \"PATCH\",\r\n    body: body instanceof FormData ? body : body != null ? JSON.stringify(body) : undefined,\r\n});\r\n\r\nexport const apiDel = (path: string, init: RequestInit = {}) =>\r\n  apiFetch(path, { ...init, method: \"DELETE\" });\r\n\r\nexport async function jsonOrThrow<T = any>(res: Response): Promise<T> {\r\n  if (!res.ok) throw new Error(await getErrorText(res));\r\n  const text = await res.text();\r\n  if (!text) return {} as T;\r\n  return JSON.parse(text) as T;\r\n}\r\n\r\nexport async function clientGetMe<T = any>() {\r\n  const res = await apiGet(\"/v1/me\");\r\n  if (!res.ok) return null;\r\n  return res.json() as Promise<T>;\r\n}"],"names":["getCookie","name","pairs","pair","eq","setCookie","value","refreshInFlight","doRefresh","res","j","token","refreshAccessToken","FIELD_LABELS","humanizeField","raw","last","m","toErrorText","msg","det","field","label","getErrorInfo","text","fieldErrors","err","baseMsg","d","message","first","getErrorText","apiFetch","path","init","headers","csrf","newToken","retriedHeaders","apiGet","apiPost","body","apiPut","apiPatch","apiDel","jsonOrThrow"],"mappings":"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"}