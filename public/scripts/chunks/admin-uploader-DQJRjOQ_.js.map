{"version":3,"file":"admin-uploader-DQJRjOQ_.js","sources":["../../../src/lib/admin-uploader.ts"],"sourcesContent":["import { apiPost, jsonOrThrow } from \"./api\";\r\n\r\nexport function makeToaster(statusElId = \"status\", opts?: { okMs?: number, errMs: number }) {\r\n    const okMs = opts?.okMs ?? 1600;\r\n    const errMs = opts?.errMs ?? 5000;\r\n    const el = document.getElementById(statusElId);\r\n    let timer: number | null = null;\r\n\r\n    function show(msg: string, type: \"\" | \"ok\" | \"err\" = \"\", ms?:number) {\r\n        if (!el) return;\r\n        el.textContent = msg;\r\n        el.className = `status show ${type}`;\r\n        if (timer) window.clearTimeout(timer);\r\n        const dur = ms ?? (type === \"err\" ? errMs : okMs);\r\n        if (dur > 0) timer = window.setTimeout(clear, dur);\r\n    }\r\n    function clear() {\r\n        if(!el) return;\r\n        el.className = \"status\";\r\n        el.textContent = \"\";\r\n    }\r\n    return { show, clear};\r\n}\r\n\r\nexport type SignPayload = {\r\n    resourceType?: \"image\" | \"video\";\r\n    folder?: string;\r\n    publicId?: string;\r\n    eager?: string;\r\n    incomingTransform?: string;\r\n};\r\nexport type Signature = {\r\n    cloudName: string;\r\n    apiKey: string;\r\n    signature: string;\r\n    timestamp: string;\r\n    folder?: string;\r\n    publicId?: string;\r\n    transformation?: string;\r\n    eager?: string;\r\n    resourceType?: \"image\" | \"video\";\r\n}\r\n\r\nexport async function requestSignature(payload: SignPayload): Promise<Signature> {\r\n    const res = await apiPost(\"/v1/media/sign\", payload);\r\n    return jsonOrThrow<Signature>(res);\r\n}\r\n\r\nexport async function uploadToCloudinary(file: File, sig: Signature): Promise<any> {\r\n    const resourceType = sig.resourceType || \"image\";\r\n    const url = `https://api.cloudinary.com/v1_1/${sig.cloudName}/${resourceType}/upload`;\r\n\r\n    const form = new FormData();\r\n    form.append(\"file\", file);\r\n    form.append(\"api_key\", String(sig.apiKey));\r\n    form.append(\"timestamp\", String(sig.timestamp));\r\n    form.append(\"signature\", String(sig.signature));\r\n    if (sig.folder) form.append(\"folder\", String(sig.folder));\r\n    if (sig.publicId) form.append(\"public_id\", String(sig.publicId));\r\n    if (sig.transformation) form.append(\"transformation\", String(sig.transformation));\r\n    if(sig.eager) form.append(\"eager\", sig.eager);\r\n\r\n    const r = await fetch(url, { method: \"POST\", body: form });\r\n    if(!r.ok) throw new Error(`Error subiendo a Cloudinary (${r.status})`);\r\n    return r.json();\r\n}\r\n\r\nexport function markInvalid(input: HTMLElement | null, msg= \"Dato invÃ¡lido\") {\r\n    if(!input) return;\r\n    input.classList.add(\"is-invalid\", \"invalid\");\r\n    input.setAttribute(\"aria-invalid\", \"true\");\r\n    \r\n    const label = input.closest(\"label\") || input.parentElement;\r\n    label?.querySelectorAll(\".err-tip\").forEach(n => n.remove());\r\n\r\n    const tip = document.createElement(\"small\");\r\n    tip.className = \"err-tip\";\r\n    tip.role = \"alert\";\r\n    tip.textContent = msg;\r\n    \r\n    const tipId = `${(input as HTMLInputElement).id || \"field\"}-err`;\r\n    tip.id = tipId;\r\n\r\n    const prev = (input as HTMLInputElement).getAttribute(\"aria-describedby\");\r\n    const described = prev ? new Set(prev.split(\" \").filter(Boolean)) : new Set<string>();\r\n    described.add(tipId);\r\n    (input as HTMLInputElement).setAttribute(\"aria-describedby\", Array.from(described).join(\" \"));\r\n\r\n    (label || input.parentElement || input).appendChild(tip);\r\n}\r\n\r\nexport function clearFieldError(input: HTMLElement | null) {\r\n    if (!input) return;\r\n    input.classList.remove(\"is-invalid\", \"invalid\");\r\n    const label = input.closest(\"label\") || input.parentElement;\r\n    const tip = label?.querySelector?.(\".err-tip\") as HTMLElement | null;\r\n    \r\n    if (tip) {\r\n        const tipId = tip.id || `${(input as HTMLInputElement).id || \"field\"}-err`;\r\n        tip.remove();\r\n        \r\n        const prev = (input as HTMLInputElement).getAttribute(\"aria-describedby\");\r\n        if (prev) {\r\n            const left = prev.split(\" \").filter(p => p && p !== tipId);\r\n            if (left.length) {\r\n                (input as HTMLInputElement).setAttribute(\"aria-describedby\", left.join(\" \"));\r\n            } else {\r\n                (input as HTMLInputElement).removeAttribute(\"aria-describedby\");\r\n            }\r\n        }\r\n    }\r\n    const hasMore = (label || input.parentElement)?.querySelector(\".err-tip\");\r\n    if (!hasMore) {\r\n        input.removeAttribute(\"aria-invalid\");\r\n    }\r\n}\r\n\r\nexport function bindClearOnInput(elements: Array<HTMLElement | null>) {\r\n    elements.forEach((el) => {\r\n        if (!el) return;\r\n        [\"input\", \"change\"].forEach((ev) => \r\n            el.addEventListener(ev, () => clearFieldError(el as HTMLElement))\r\n        );\r\n    })\r\n}\r\n\r\nexport function clearFileInput(fileEl: HTMLInputElement | null) {\r\n    if (!fileEl) return;\r\n    fileEl.value = \"\";\r\n}\r\n\r\nexport function assertImage(file: File, maxMB = 10) {\r\n  if (!/^image\\//.test(file.type)) {\r\n    throw new Error(\"Formato no soportado\");\r\n  }\r\n  const mb = file.size / (1024 * 1024);\r\n  if (mb > maxMB) {\r\n    throw new Error(`La imagen supera ${maxMB}MB`);\r\n  }\r\n}"],"names":["makeToaster","statusElId","opts","okMs","errMs","el","timer","show","msg","type","ms","dur","clear","requestSignature","payload","res","apiPost","jsonOrThrow","uploadToCloudinary","file","sig","resourceType","url","form","r","markInvalid","input","label","n","tip","tipId","prev","described","clearFieldError","_a","left","p","_b","clearFileInput","fileEl","assertImage","maxMB"],"mappings":"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"}