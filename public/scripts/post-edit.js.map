{"version":3,"file":"post-edit.js","sources":["../../src/scripts/post-edit.ts"],"sourcesContent":["import EditorJS from \"@editorjs/editorjs\";\r\nimport Header from \"@editorjs/header\";\r\nimport List from \"@editorjs/list\";\r\nimport ImageTool from \"@editorjs/image\";\r\n\r\nimport { apiGet, apiPut, getErrorInfo, toErrorText } from \"../lib/api\";\r\nimport {\r\n  requestSignature,\r\n  uploadToCloudinary,\r\n  assertImage,\r\n  makeToaster,\r\n  markInvalid,\r\n  clearFieldError,\r\n  clearFileInput,\r\n} from \"../lib/admin-uploader\";\r\n\r\nconst $ = {\r\n  titulo: () => document.getElementById(\"titulo\") as HTMLInputElement | null,\r\n  excerpt: () => document.getElementById(\"excerpt\") as HTMLTextAreaElement | null,\r\n  portadaUrl: () => document.getElementById(\"portadaUrl\") as HTMLInputElement | null,\r\n  portadaFile: () => document.getElementById(\"portadaFile\") as HTMLInputElement | null,\r\n  destacado: () => document.getElementById(\"destacado\") as HTMLInputElement | null,\r\n  saveBtn: () => document.getElementById(\"saveBtn\") as HTMLButtonElement | null,\r\n  cfg: () => document.getElementById(\"cfg\") as HTMLElement | null,\r\n};\r\n\r\nfunction clearFieldErrors() {\r\n  document.querySelectorAll(\".invalid\").forEach((el) => el.classList.remove(\"invalid\"));\r\n  document.querySelectorAll(\".err-tip\").forEach((el) => el.remove());\r\n}\r\n\r\nfunction markFieldErrors(fieldErrors: { field: string; message: string }[]) {\r\n  clearFieldErrors();\r\n\r\n  for (const { field, message } of fieldErrors) {\r\n    const el =\r\n      (field === \"titulo\" && $.titulo()) ||\r\n      (field === \"excerpt\" && $.excerpt()) ||\r\n      (field === \"portadaUrl\" && $.portadaUrl()) ||\r\n      (field === \"destacado\" && $.destacado()) ||\r\n      null;\r\n\r\n    if (!el) continue;\r\n\r\n    el.classList.add(\"invalid\");\r\n    const tip = document.createElement(\"div\");\r\n    tip.className = \"err-tip\";\r\n    tip.textContent = message || \"Dato inválido\";\r\n    el.insertAdjacentElement(\"afterend\", tip);\r\n  }\r\n}\r\n\r\nfunction slugify(s: string) {\r\n  return (s || \"\")\r\n    .toLowerCase()\r\n    .normalize(\"NFD\")\r\n    .replace(/[\\u0300-\\u036f]/g, \"\")\r\n    .replace(/[^a-z0-9]+/g, \"-\")\r\n    .replace(/(^-|-$)/g, \"\")\r\n    .slice(0, 60) || \"img\";\r\n}\r\n\r\n(async () => {\r\n  const toast = makeToaster(\"status\", { okMs: 1400, errMs: 5000 });\r\n\r\n  const params = new URLSearchParams(location.search);\r\n  const id = (params.get(\"id\") || \"\").trim();\r\n  if (!id) {\r\n    toast.show(\"Falta el id en la URL\", \"err\");\r\n    return;\r\n  }\r\n\r\n  const cfg = $.cfg();\r\n  const DEFAULT_FOLDER = cfg?.dataset.folder || \"posts\";\r\n  const rawType = cfg?.dataset.resourceType;\r\n  const RESOURCE_TYPE: \"image\" | \"video\" = rawType === \"video\" ? \"video\" : \"image\";\r\n\r\n  const tituloEl = $.titulo();\r\n  const excerptEl = $.excerpt();\r\n  const portadaEl = $.portadaUrl();\r\n  const fileEl = $.portadaFile();\r\n  const destacadoEl = $.destacado();\r\n  const saveBtn = $.saveBtn();\r\n\r\n  if (!tituloEl || !excerptEl || !portadaEl || !destacadoEl) {\r\n    toast.show(\"Faltan campos del formulario en el DOM\", \"err\");\r\n    return;\r\n  }\r\n\r\n  // ---- Cargar post ----\r\n  let post: any = null;\r\n\r\n  try {\r\n    const res = await apiGet(`/v1/posts/${encodeURIComponent(id)}`);\r\n    post = res.ok ? await res.json() : null;\r\n  } catch {\r\n    post = null;\r\n  }\r\n\r\n  if (!post) {\r\n    const raw = localStorage.getItem(\"cms:postEdit\");\r\n    if (raw) {\r\n      try {\r\n        post = JSON.parse(raw);\r\n      } catch {\r\n        post = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!post) {\r\n    toast.show(\"No se pudo cargar la noticia\", \"err\");\r\n    return;\r\n  }\r\n\r\n  // ---- Hydrate form ----\r\n  tituloEl.value = post.titulo || \"\";\r\n  excerptEl.value = post.excerpt || \"\";\r\n  portadaEl.value = post.portadaUrl || \"\";\r\n  destacadoEl.checked = !!post.destacado;\r\n\r\n  // ---- EditorJS ----\r\n  const editor = new EditorJS({\r\n    holder: \"editorjs\",\r\n    autofocus: true,\r\n    placeholder: \"Escribí acá…\",\r\n    tools: {\r\n      header: {\r\n        class: Header as any,\r\n        inlineToolbar: true,\r\n        config: { levels: [2, 3, 4], defaultLevel: 2 },\r\n      },\r\n      list: { class: List as any, inlineToolbar: true },\r\n      image: {\r\n        class: ImageTool as any,\r\n        config: {\r\n          captionPlaceholder: \"Pie de imagen\",\r\n          uploader: {\r\n            async uploadByFile(file: File) {\r\n              // Validación unificada\r\n              assertImage(file, 10);\r\n\r\n              toast.show(\"Subiendo imagen…\");\r\n\r\n              const titulo = tituloEl.value || \"\";\r\n\r\n              const sig = await requestSignature({\r\n                resourceType: RESOURCE_TYPE,\r\n                folder: DEFAULT_FOLDER,\r\n                incomingTransform: \"c_limit,w_2560/f_webp,q_auto:good\",\r\n              });\r\n\r\n              const resp = await uploadToCloudinary(file, sig);\r\n              toast.clear();\r\n\r\n              return { success: 1, file: { url: resp.secure_url } };\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n    data:\r\n      post.blocksJson || {\r\n        time: Date.now(),\r\n        blocks: [{ type: \"paragraph\", data: { text: \"\" } }],\r\n        version: \"2.28.0\",\r\n      },\r\n  });\r\n\r\n  // ---- Portada upload ----\r\n  fileEl?.addEventListener(\"change\", async (e) => {\r\n    const input = e.currentTarget as HTMLInputElement | null;\r\n    const file = input?.files?.[0];\r\n    if (!file) return;\r\n\r\n    try {\r\n      assertImage(file, 10);\r\n    } catch (err: any) {\r\n      markInvalid(fileEl, err?.message || \"Archivo inválido\");\r\n      clearFileInput(fileEl);\r\n      return toast.show(err?.message || \"Archivo inválido\", \"err\");\r\n    }\r\n\r\n    try {\r\n      toast.show(\"Subiendo portada…\");\r\n\r\n      const sig = await requestSignature({\r\n        resourceType: RESOURCE_TYPE,\r\n        folder: `${DEFAULT_FOLDER}/portadas`,\r\n        incomingTransform: \"c_limit,w_2560/f_webp,q_auto:good\",\r\n      });\r\n\r\n      const resp = await uploadToCloudinary(file, sig);\r\n      portadaEl.value = resp.secure_url;\r\n\r\n      clearFieldError(fileEl);\r\n      clearFileInput(fileEl);\r\n\r\n      toast.show(\"Imagen subida ✅\", \"ok\");\r\n    } catch (err: any) {\r\n      console.error(err);\r\n      markInvalid(fileEl, err?.message || \"No se pudo subir la imagen\");\r\n      clearFileInput(fileEl);\r\n      toast.show(err?.message || \"No se pudo subir la imagen\", \"err\");\r\n    }\r\n  });\r\n\r\n  // ---- Guardar ----\r\n  saveBtn?.addEventListener(\"click\", async () => {\r\n    try {\r\n      clearFieldErrors();\r\n      toast.show(\"Guardando…\");\r\n\r\n      const blocks = await editor.save();\r\n      const titulo = (tituloEl.value || \"\").trim();\r\n      const excerpt = (excerptEl.value || \"\").trim();\r\n      const portada = (portadaEl.value || \"\").trim();\r\n      const destacado = !!destacadoEl.checked;\r\n\r\n      if (!titulo) {\r\n        markInvalid(tituloEl, \"Falta el título\");\r\n        toast.show(\"Falta el título\", \"err\");\r\n        return;\r\n      }\r\n\r\n      const body: any = { tipo: \"noticia\", titulo, destacado, blocksJson: blocks };\r\n      if (excerpt) body.excerpt = excerpt;\r\n      if (portada) body.portadaUrl = portada;\r\n\r\n      const res = await apiPut(`/v1/posts/${encodeURIComponent(id)}`, body);\r\n\r\n      if (!res.ok) {\r\n        const { text, fieldErrors } = await getErrorInfo(res);\r\n        markFieldErrors(fieldErrors.map((fe) => ({ field: fe.field, message: fe.message })));\r\n        toast.show(text, \"err\");\r\n        return;\r\n      }\r\n\r\n      localStorage.removeItem(\"cms:postEdit\");\r\n      toast.show(\"Guardado ✅\", \"ok\");\r\n    } catch (err: any) {\r\n      console.error(err);\r\n      toast.show(toErrorText(err) || \"Error al guardar\", \"err\");\r\n    }\r\n  });\r\n})();\r\n"],"names":["$","clearFieldErrors","el","markFieldErrors","fieldErrors","field","message","tip","toast","makeToaster","id","cfg","DEFAULT_FOLDER","RESOURCE_TYPE","tituloEl","excerptEl","portadaEl","fileEl","destacadoEl","saveBtn","post","res","apiGet","raw","editor","EditorJS","Header","List","ImageTool","file","assertImage","sig","requestSignature","resp","uploadToCloudinary","e","input","_a","err","markInvalid","clearFileInput","clearFieldError","blocks","titulo","excerpt","portada","destacado","body","apiPut","text","getErrorInfo","fe","toErrorText"],"mappings":"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"}