import{f as B}from"./chunks/api-gnd9IJTx.js";const q="/v1/media/folders",F="/v1/media/assets",O="/v1/media/asset";document.addEventListener("DOMContentLoaded",()=>{P()});async function P(){const c=document.getElementById("folderTree"),u=document.getElementById("grid"),x=document.getElementById("reload"),y=document.getElementById("prev"),f=document.getElementById("next"),L=document.getElementById("info"),$=document.getElementById("toast"),C=document.querySelector(".used-filter"),E=document.getElementById("previewModal"),I=document.getElementById("previewTitle"),k=document.getElementById("previewBody"),A=document.getElementById("previewMeta"),T=document.getElementById("previewCopy"),S=document.getElementById("previewOpen"),U=document.getElementById("previewClose");if(!c||!u||!x||!y||!f||!L||!$||!E||!I||!k||!A||!T||!S||!U){console.warn("[admin-medios] Faltan elementos del DOM. Abortando init.");return}function M(e){$.textContent=e,$.className="toast show",setTimeout(()=>$.className="toast",1600)}const s={folder:"all",cursor:null,prevStack:[],totalApprox:0,lastItems:[],used:"all"};function R(e){const t={children:new Map},a=new Map(e.map(n=>[n.path,n.name||String(n.path).split("/").pop()]));for(const n of e){const o=String(n.path).split("/");let r=t;const i=[];for(let v=0;v<o.length;v++){const l=o[v];i.push(l);const g=i.join("/");r.children.has(l)||r.children.set(l,{key:g,label:a.get(g)||l,children:new Map}),r=r.children.get(l)}}return t}function H(e,t){const a=Array.from(e.children.values()).sort((n,o)=>n.label.localeCompare(o.label,"es"));for(const n of a){const o=document.createElement("li"),r=n.children.size>0;if(o.innerHTML=`
        <button class="node ${s.folder===n.key?"active":""}" data-path="${n.key}">
          ${r?'<span class="chev">▾</span>':'<span class="leaf" aria-hidden="true"></span>'}
          <span class="label">${p(n.label)}</span>
        </button>
      `,t.appendChild(o),r){const i=document.createElement("ul");o.appendChild(i),H(n,i)}}}async function _(){c.innerHTML="";const e=document.createElement("button");e.className="node "+(s.folder==="all"?"active":""),e.dataset.path="all",e.innerHTML='<span class="chev" aria-hidden="true">●</span><span class="label">Todas</span>',c.appendChild(e);try{const t=await B(q,{method:"GET"});if(!t.ok)throw new Error(await t.text());const{folders:a=[]}=await t.json(),n=R(a),o=document.createElement("ul");c.appendChild(o),H(n,o)}catch(t){console.error(t);const a=document.createElement("div");a.className="sub",a.style.padding=".4rem .6rem",a.textContent="No se pudieron cargar carpetas",c.appendChild(a)}}c.addEventListener("click",e=>{const t=e.target.closest(".node");if(!t)return;const a=t.dataset.path||"all";a!==s.folder&&(s.folder=a,s.cursor=null,s.prevStack=[],c.querySelectorAll(".node").forEach(n=>n.classList.toggle("active",n===t)),h())});async function h({cursor:e=null}={}){u.innerHTML='<div class="media-card" style="padding:1rem">Cargando…</div>';try{const t=new URLSearchParams;s.folder&&s.folder!=="all"&&t.set("folder",s.folder),s.used!=="all"&&t.set("used",s.used),e&&t.set("cursor",e);const a=await B(`${F}?${t.toString()}`,{method:"GET"});if(!a.ok){const r=await a.json().catch(()=>({}));u.innerHTML=`<div class="media-card" style="padding:1rem;color:#a3122a">Error: ${p(r.error||String(a.status))}</div>`,f.disabled=y.disabled=!0,L.textContent="";return}const n=await a.json();let o=Array.isArray(n.items)?n.items:[];if(s.used!=="all"){const r=s.used==="true";o=o.filter(i=>!!i.used===r)}s.lastItems=o,s.totalApprox=n.totalCountApprox??0,j(o),f.disabled=!n.nextCursor,f.dataset.cursor=n.nextCursor||"",y.disabled=s.prevStack.length===0,L.textContent=s.totalApprox?`~${s.totalApprox} elementos`:""}catch(t){console.error(t),u.innerHTML='<div class="media-card" style="padding:1rem;color:#a3122a">Error listando medios</div>',f.disabled=y.disabled=!0,L.textContent=""}}function j(e){if(e.length===0){u.innerHTML='<div class="media-card" style="padding:1rem">Sin resultados</div>';return}u.innerHTML="";for(const t of e){const a=t.publicId||t.public_id||"",n=t.secureUrl||t.secure_url||t.url||"",o=t.width||0,r=t.height||0,i=t.format||"",v=t.folder||"",l=t.resourceType||t.resource_type||"image",g=!!t.used,b=String(a||"").split("/").pop(),m=document.createElement("div");m.className="media-card",m.dataset.publicId=a,m.dataset.url=n,m.dataset.kind=l,m.innerHTML=`
        <div class="thumb">
          ${l==="video"?`<video src="${w(n)}" muted playsinline preload="metadata"></video>`:n?`<img src="${w(n)}" alt="${w(b||"")}">`:"<span>sin vista</span>"}
        </div>
        <div class="meta">
          <div class="name" title="${w(a)}">${p(b||"(sin nombre)")}</div>
          <div class="sub">${p(String(o||"?"))}×${p(String(r||"?"))} · ${p(i||"?")}</div>
          <div class="row">
            ${v?`<span class="tag">${p(v)}</span>`:""}
            ${l==="video"?'<span class="tag">video</span>':""}
            <span class="badge ${g?"is-used":"is-unused"}">${g?"En uso":"Libre"}</span>
          </div>
          <div class="ops">
            <button class="kbtn" data-act="copy" data-url="${w(n)}">Copiar URL</button>
            <button class="kbtn danger solid" data-act="del" data-id="${encodeURIComponent(a)}">Eliminar</button>
          </div>
        </div>
      `,m.addEventListener("click",d=>{d.target.closest("button")||N(t)}),u.appendChild(m)}}u.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const a=t.dataset.act;if(a==="copy"){const n=t.dataset.url||"";if(!n)return;await navigator.clipboard.writeText(n),M("URL copiada"),e.stopPropagation();return}if(a==="del"){const n=t.dataset.id?decodeURIComponent(t.dataset.id):"";if(!n||(e.stopPropagation(),!confirm(`¿Eliminar "${n}"?`)))return;const o=await B(`${O}?publicId=${encodeURIComponent(n)}`,{method:"DELETE"});if(o.ok)M("Eliminado"),await h();else{const r=await o.json().catch(()=>({}));alert(r.error||"No se pudo eliminar")}}}),f.addEventListener("click",()=>{const e=f.dataset.cursor;e&&(s.prevStack.push(e),h({cursor:e}))}),y.addEventListener("click",()=>{s.prevStack.pop();const e=s.prevStack[s.prevStack.length-1]||null;h({cursor:e||null})}),C==null||C.addEventListener("click",e=>{const t=e.target.closest(".seg-btn");t&&(C.querySelectorAll(".seg-btn").forEach(a=>a.classList.toggle("active",a===t)),s.used=t.dataset.used||"all",s.cursor=null,s.prevStack=[],h())}),x.addEventListener("click",()=>void h());function N(e){const t=e.publicId||e.public_id||"",a=e.secureUrl||e.secure_url||e.url||"",n=e.width||0,o=e.height||0,r=e.format||"",i=e.folder||"",v=!!e.used,l=e.resourceType||e.resource_type||"image",g=e.createdAt||e.created_at||"";if(I.textContent=String(t||"").split("/").pop()||"Vista previa",k.innerHTML="",l==="video"){const d=document.createElement("video");d.src=a,d.controls=!0,d.playsInline=!0,k.appendChild(d)}else{const d=document.createElement("img");d.src=a,d.alt=I.textContent||"",k.appendChild(d)}const b=Array.isArray(e.usages)?e.usages:[],m=b.length?b.map(d=>`${p(d.kind||"")}${d.titulo?` — ${p(d.titulo)}`:""}`).join("<br>"):"—";A.innerHTML=[["Archivo",t||"—"],["Carpeta",i||"—"],["Tamaño",`${n||"?"} × ${o||"?"}`],["Formato",r||"—"],["Creado",g?new Date(g).toLocaleString("es-AR"):"—"],["Estado",v?"En uso":"Libre"],["Usos",m]].map(([d,D])=>`<div class="row"><b>${p(d)}</b><div>${String(D)}</div></div>`).join(""),T.dataset.url=a,S.dataset.url=a,E.showModal()}T.addEventListener("click",async()=>{const e=T.dataset.url||"";e&&(await navigator.clipboard.writeText(e),M("URL copiada"))}),S.addEventListener("click",()=>{const e=S.dataset.url||"";e&&window.open(e,"_blank","noopener,noreferrer")}),U.addEventListener("click",()=>E.close()),E.addEventListener("click",e=>{e.target===E&&E.close()}),await _(),await h()}function p(c){return String(c||"").replace(/[&<>"']/g,u=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[u])}function w(c){return String(c||"").replace(/"/g,"&quot;")}
//# sourceMappingURL=admin-medios.js.map
