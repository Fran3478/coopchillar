import{e as L,f as A,A as R,P,G as q,v as C,a as T,r as F,u as x,m as E,c as y,b as D,h as N,g as G,t as O}from"./chunks/admin-uploader-3KBZ3FC9.js";const r={titulo:()=>document.getElementById("titulo"),excerpt:()=>document.getElementById("excerpt"),portadaUrl:()=>document.getElementById("portadaUrl"),portadaFile:()=>document.getElementById("portadaFile"),destacado:()=>document.getElementById("destacado"),saveBtn:()=>document.getElementById("saveBtn"),cfg:()=>document.getElementById("cfg")};function U(){document.querySelectorAll(".invalid").forEach(e=>e.classList.remove("invalid")),document.querySelectorAll(".err-tip").forEach(e=>e.remove())}function $(e){U();for(const{field:d,message:u}of e){const s=d==="titulo"&&r.titulo()||d==="excerpt"&&r.excerpt()||d==="portadaUrl"&&r.portadaUrl()||d==="destacado"&&r.destacado()||null;if(!s)continue;s.classList.add("invalid");const i=document.createElement("div");i.className="err-tip",i.textContent=u||"Dato inválido",s.insertAdjacentElement("afterend",i)}}(async()=>{const e=L("status",{okMs:1400,errMs:5e3}),u=(new URLSearchParams(location.search).get("id")||"").trim();if(!u){e.show("Falta el id en la URL","err");return}const s=r.cfg(),i=(s==null?void 0:s.dataset.folder)||"posts",b=(s==null?void 0:s.dataset.resourceType)==="video"?"video":"image",m=r.titulo(),v=r.excerpt(),f=r.portadaUrl(),c=r.portadaFile(),h=r.destacado(),w=r.saveBtn();if(!m||!v||!f||!h){e.show("Faltan campos del formulario en el DOM","err");return}let o=null;try{const a=await A(`/v1/posts/${encodeURIComponent(u)}`);o=a.ok?await a.json():null}catch{o=null}if(!o){const a=localStorage.getItem("cms:postEdit");if(a)try{o=JSON.parse(a)}catch{o=null}}if(!o){e.show("No se pudo cargar la noticia","err");return}m.value=o.titulo||"",v.value=o.excerpt||"",f.value=o.portadaUrl||"",h.checked=!!o.destacado;const _=new R({holder:"editorjs",autofocus:!0,placeholder:"Escribí acá…",tools:{header:{class:C,inlineToolbar:!0,config:{levels:[2,3,4],defaultLevel:2}},list:{class:q,inlineToolbar:!0},image:{class:P,config:{captionPlaceholder:"Pie de imagen",uploader:{async uploadByFile(a){T(a,10),e.show("Subiendo imagen…"),m.value;const n=await F({resourceType:b,folder:i,incomingTransform:"c_limit,w_2560/f_webp,q_auto:good"}),l=await x(a,n);return e.clear(),{success:1,file:{url:l.secure_url}}}}}}},data:o.blocksJson||{time:Date.now(),blocks:[{type:"paragraph",data:{text:""}}],version:"2.28.0"}});c==null||c.addEventListener("change",async a=>{var p;const n=a.currentTarget,l=(p=n==null?void 0:n.files)==null?void 0:p[0];if(l){try{T(l,10)}catch(t){return E(c,(t==null?void 0:t.message)||"Archivo inválido"),y(c),e.show((t==null?void 0:t.message)||"Archivo inválido","err")}try{e.show("Subiendo portada…");const t=await F({resourceType:b,folder:`${i}/portadas`,incomingTransform:"c_limit,w_2560/f_webp,q_auto:good"}),g=await x(l,t);f.value=g.secure_url,D(c),y(c),e.show("Imagen subida ✅","ok")}catch(t){console.error(t),E(c,(t==null?void 0:t.message)||"No se pudo subir la imagen"),y(c),e.show((t==null?void 0:t.message)||"No se pudo subir la imagen","err")}}}),w==null||w.addEventListener("click",async()=>{try{U(),e.show("Guardando…");const a=await _.save(),n=(m.value||"").trim(),l=(v.value||"").trim(),p=(f.value||"").trim(),t=!!h.checked;if(!n){E(m,"Falta el título"),e.show("Falta el título","err");return}const g={tipo:"noticia",titulo:n,destacado:t,blocksJson:a};l&&(g.excerpt=l),p&&(g.portadaUrl=p);const I=await N(`/v1/posts/${encodeURIComponent(u)}`,g);if(!I.ok){const{text:B,fieldErrors:S}=await G(I);$(S.map(k=>({field:k.field,message:k.message}))),e.show(B,"err");return}localStorage.removeItem("cms:postEdit"),e.show("Guardado ✅","ok")}catch(a){console.error(a),e.show(O(a)||"Error al guardar","err")}})})();
//# sourceMappingURL=post-edit.js.map
