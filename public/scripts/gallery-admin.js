import{d as re,g as v,a as Z,t as J,e as oe,b as j}from"./chunks/api-gnd9IJTx.js";function l(o){return(o||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[c])}function de(o){return o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase()}function Q(o){if(!o)return"";const c=new Date(o);return Number.isNaN(+c)?o:c.toLocaleString("es-AR",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("cfg-media"),c=(o==null?void 0:o.dataset.folder)||"gallery",W=(o==null?void 0:o.dataset.resourceType)||"image",E=document.getElementById("cards"),b=document.getElementById("status"),_=document.getElementById("btn-new"),L=document.getElementById("btn-reload"),w=document.getElementById("btn-load-more"),q=document.getElementById("q"),C=document.getElementById("f-status"),F=document.getElementById("f-album"),T=document.getElementById("dlg-edit"),S=document.getElementById("form-edit"),X=document.getElementById("dlg-title"),h=document.getElementById("file"),u=document.getElementById("url"),f=document.getElementById("album"),k=document.getElementById("estado"),I=document.getElementById("alt"),g=document.getElementById("descripcion"),m=document.getElementById("btn-upload"),x=document.getElementById("btn-cancel"),P=document.getElementById("dlg-view"),U=document.getElementById("view-body"),D=document.getElementById("btn-close-view"),p=document.getElementById("dlg-del"),ee=document.getElementById("del-msg"),A=document.getElementById("btn-cancel-del"),te=document.getElementById("btn-confirm-del"),z=document.getElementById("upload-block"),R=document.getElementById("edit-note");let B=null,N=1,H=!1,r=null;function d(e,t=""){b&&(b.textContent=e,b.className=`status show ${t}`,t==="ok"&&setTimeout(()=>b.className="status",1600))}async function ae(e){const t=await Z("/v1/media/sign",e);if(!t.ok)throw new Error("No se pudo obtener la firma");return t.json()}async function ne(e,t){const a=t.resourceType||"image",s=`https://api.cloudinary.com/v1_1/${t.cloudName}/${a}/upload`,n=new FormData;n.append("file",e),n.append("api_key",String(t.apiKey)),n.append("timestamp",String(t.timestamp)),n.append("signature",String(t.signature)),t.folder&&n.append("folder",t.folder),t.publicId&&n.append("public_id",t.publicId),t.transformation&&n.append("transformation",t.transformation);const i=await fetch(s,{method:"POST",body:n});if(!i.ok)throw new Error(`Error subiendo a Cloudinary (${i.status})`);return i.json()}function se(e){const t=e.album??"—",a=e.estado??"draft",s=e.alt??"",n=e.description??e.descripcion??"";return`
      <div class="card clickable" role="button" tabindex="0" data-id="${e.id}">
        <div class="thumb">${e.url?`<img src="${e.url}" alt="${l(s)}">`:"Sin imagen"}</div>
        <div class="body">
          <div class="chips">
            <span class="chip">Álbum: ${l(t)}</span>
            <span class="chip">Estado: ${l(a==="published"?"Publicado":a==="draft"?"Borrador":"Archivado")}</span>
          </div>
          ${n?`<div style="font-size:.9rem;color:var(--muted)">${l(n)}</div>`:""}
          <div class="row" style="margin-top:.6rem">
            <button class="btn" data-act="edit">Editar</button>
            <div class="grow"></div>
            <button class="btn" data-act="del">Eliminar</button>
          </div>
        </div>
      </div>`}async function y(e=!0){e&&(N=1,E.innerHTML="");const t=new URLSearchParams;q.value.trim()&&t.set("q",q.value.trim()),C.value&&t.set("estado",C.value),F.value.trim()&&t.set("album",F.value.trim()),t.set("page",String(N)),t.set("limit","24");const a=await j(`/v1/media/gallery/assets?${t.toString()}`);if(!a.ok){const{text:i}=await v(a);d(i,"err");return}const s=await a.json(),n=s.items??s.data??s.results??[];H=!!s.hasMore||Array.isArray(n)&&n.length===24,w.hidden=!H;for(const i of n)E.insertAdjacentHTML("beforeend",se(i))}function M(e){e?(z.hidden=!0,R.hidden=!1,h.disabled=!0,u.disabled=!0,m.disabled=!0,m.hidden=!0):(z.hidden=!1,R.hidden=!0,h.disabled=!1,u.disabled=!1,m.disabled=!1,m.hidden=!1)}function O(e){u.value=(e==null?void 0:e.url)??"",f.value=(e==null?void 0:e.album)??"",k.value=(e==null?void 0:e.estado)??"draft",I.value=(e==null?void 0:e.alt)??"",g.value=(e==null?void 0:e.description)??(e==null?void 0:e.descripcion)??"",h.value="",r=null}async function G(e){if(B=e,X.textContent=e?"Editar imagen":"Nueva imagen",e){M(!0);const t=await j(`/v1/media/gallery/assets/${e}`);if(!t.ok){d((await v(t)).text,"err");return}const a=await t.json();O(a)}else M(!1),O(void 0);T.showModal()}async function K(e){const t=await j(`/v1/media/gallery/assets/${e}`);if(!t.ok){d((await v(t)).text,"err");return}const a=await t.json(),s=a.album??"—",n=a.estado??"draft",i=a.alt??"",$=a.description??a.descripcion??"";U.innerHTML=`
      <div style="height:240px; background:#fafafa; border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:.75rem;">
        ${a.url?`<img src="${a.url}" alt="${l(i)}" style="width:100%;height:100%;object-fit:contain;background:#fff">`:""}
      </div>
      <div class="view-kv"><div class="k">Álbum</div><div class="v">${l(s)}</div></div>
      <div class="view-kv"><div class="k">Estado</div><div class="v">${l(n==="published"?"Publicado":n==="draft"?"Borrador":"Archivado")}</div></div>
      <div class="view-kv"><div class="k">Texto alternativo</div><div class="v">${l(i)}</div></div>
      <div class="view-kv"><div class="k">Descripción</div><div class="v">${l($)}</div></div>
      <div class="view-kv"><div class="k">Creación</div><div class="v">${l(Q(a.createdAt))}</div></div>
      <div class="view-kv"><div class="k">Actualización</div><div class="v">${l(Q(a.updatedAt))}</div></div>
    `,P.showModal()}function V(e){const t={album:f,estado:k,alt:I,description:g,descripcion:g,url:u};e.forEach(({field:a})=>{const s=t[a];s==null||s.classList.add("invalid"),setTimeout(()=>s==null?void 0:s.classList.remove("invalid"),1800)})}_==null||_.addEventListener("click",()=>G(null)),L==null||L.addEventListener("click",()=>y(!0)),w==null||w.addEventListener("click",()=>{N+=1,y(!1)}),E.addEventListener("click",e=>{const t=e.target,a=t.closest("button"),s=t.closest(".card");if(!s)return;const n=Number(s.dataset.id);if(a){const i=a.dataset.act;i==="edit"?G(n):i==="del"&&Y(n,!1);return}K(n)}),E.addEventListener("keydown",e=>{const t=e.target;if(t.classList.contains("card")&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const a=Number(t.dataset.id);K(a)}}),x==null||x.addEventListener("click",()=>{T.close(),r=null,M(!1)}),m==null||m.addEventListener("click",async()=>{var t;if(B){d("En edición no se puede cambiar la imagen.","err");return}const e=(t=h.files)==null?void 0:t[0];if(!e){d("Seleccioná un archivo","err");return}if(!/^image\//.test(e.type)){d("Formato no soportado","err");return}if(e.size>10*1024*1024){d("La imagen supera 10MB","err");return}try{d("Subiendo imagen…");const a=f.value.trim(),s=a?`${c}/${de(a)}`:c,n=await ae({resourceType:W,folder:s,incomingTransform:"c_limit,w_2560/f_webp,q_auto:good"}),i=await ne(e,n);r={public_id:i.public_id,resource_type:i.resource_type,secure_url:i.secure_url},u.value=i.secure_url,d("Imagen subida ✅","ok")}catch(a){console.error(a),d("No se pudo subir la imagen","err")}}),S==null||S.addEventListener("submit",async e=>{e.preventDefault();try{if(B){const t={alt:I.value??"",description:g.value??"",album:f.value??"",estado:k.value},a=await re(`/v1/media/gallery/assets/${B}`,t);if(!a.ok){const{text:s,fieldErrors:n}=await v(a);throw n.length&&V(n),new Error(s)}}else{const t={alt:(I.value||"").trim()||null,description:(g.value||"").trim()||null,album:(f.value||"").trim()||null,estado:k.value},a={};if(r!=null&&r.secure_url&&(a.secure_url=r.secure_url),r!=null&&r.public_id&&(a.public_id=r.public_id),r!=null&&r.resource_type&&(a.resource_type=r.resource_type),!a.secure_url&&u.value.trim()&&(a.secure_url=u.value.trim()),!a.secure_url)throw new Error("Subí una imagen o pegá una URL.");const n=await Z("/v1/media/gallery/assets",{items:[{upload:a,meta:t}]});if(!n.ok){const{text:i,fieldErrors:$}=await v(n);throw $.length&&V($),new Error(i)}}T.close(),r=null,d("Guardado ✅","ok"),await y(!0)}catch(t){console.error(t),d(J(t),"err")}}),D==null||D.addEventListener("click",()=>P.close());let ie=null;function Y(e,t){ie=e,ee.textContent=t?"La imagen está publicada. ¿Eliminar de todos modos?":"¿Seguro que querés eliminar esta imagen?",p.showModal(),te.onclick=async()=>{try{const a=t?`/v1/media/gallery/assets/${e}?force=true`:`/v1/media/gallery/assets/${e}`,s=await oe(a);if(s.status===409&&!t){p.close(),Y(e,!0);return}if(!s.ok){const{text:n}=await v(s);throw new Error(n)}p.close(),d("Eliminado ✅","ok"),await y(!0)}catch(a){console.error(a),p.close(),d(J(a),"err")}}}A==null||A.addEventListener("click",()=>p.close()),y(!0)});
//# sourceMappingURL=gallery-admin.js.map
